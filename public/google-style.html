<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>üìÖ Kalend√°r - Google Style</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
      background: #ffffff;
      color: #3c4043;
      height: 100vh;
      overflow: hidden;
    }

    /* Top Header */
    .header {
      height: 64px;
      background: #fff;
      border-bottom: 1px solid #dadce0;
      display: flex;
      align-items: center;
      padding: 0 20px;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 22px;
      color: #5f6368;
      font-weight: 400;
    }

    .calendar-selector {
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 4px;
      color: #3c4043;
      font-size: 14px;
      cursor: pointer;
      min-width: 200px;
    }

    .header-right {
      display: flex;
      gap: 10px;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #5f6368;
    }

    .icon-btn:hover {
      background: #f1f3f4;
    }

    /* Main Container */
    .main-container {
      display: flex;
      height: calc(100vh - 64px);
    }

    /* Sidebar */
    .sidebar {
      width: 256px;
      background: #fff;
      border-right: 1px solid #dadce0;
      overflow-y: auto;
      padding: 20px 12px;
    }

    .create-btn {
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 24px;
      padding: 12px 24px;
      font-size: 14px;
      color: #3c4043;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
      margin-bottom: 20px;
    }

    .create-btn:hover {
      background: #f8f9fa;
      box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
    }

    .mini-calendar {
      margin-bottom: 20px;
    }

    .mini-calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 14px;
      font-weight: 500;
    }

    .mini-nav-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #5f6368;
      font-size: 18px;
      padding: 4px;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mini-nav-btn:hover {
      background: #f1f3f4;
    }

    .mini-calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      font-size: 11px;
      text-align: center;
    }

    .mini-day-header {
      color: #70757a;
      font-weight: 500;
      padding: 4px 0;
    }

    .mini-day {
      padding: 4px;
      cursor: pointer;
      border-radius: 50%;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mini-day:hover {
      background: #f1f3f4;
    }

    .mini-day.today {
      background: #1a73e8;
      color: #fff;
    }

    .mini-day.other-month {
      color: #dadce0;
    }

    .calendars-list {
      margin-top: 20px;
    }

    .calendars-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
      color: #5f6368;
    }

    .calendar-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: #3c4043;
    }

    .calendar-item:hover {
      background: #f1f3f4;
    }

    .calendar-checkbox {
      width: 16px;
      height: 16px;
      accent-color: #1a73e8;
    }

    .calendar-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    /* Calendar View */
    .calendar-view {
      flex: 1;
      overflow: auto;
      background: #fff;
    }

    .calendar-controls {
      height: 60px;
      border-bottom: 1px solid #dadce0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }

    .view-controls {
      display: flex;
      gap: 10px;
    }

    .view-btn {
      padding: 8px 16px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      color: #3c4043;
    }

    .view-btn.active {
      background: #e8f0fe;
      border-color: #1a73e8;
      color: #1a73e8;
    }

    .nav-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .nav-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #5f6368;
      font-size: 20px;
      padding: 8px;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-btn:hover {
      background: #f1f3f4;
    }

    .current-period {
      font-size: 22px;
      color: #3c4043;
      font-weight: 400;
      min-width: 200px;
      text-align: center;
    }

    .today-btn {
      padding: 8px 16px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      color: #3c4043;
    }

    .today-btn:hover {
      background: #f1f3f4;
    }

    /* Calendar Grid */
    .calendar-grid-container {
      padding: 20px;
    }

    .weekday-headers {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0;
      margin-bottom: 1px;
      border: 1px solid #dadce0;
      background: #fff;
    }

    .weekday-header {
      padding: 12px;
      text-align: center;
      font-size: 11px;
      font-weight: 500;
      color: #70757a;
      text-transform: uppercase;
      border-right: 1px solid #dadce0;
    }

    .weekday-header:last-child {
      border-right: none;
    }

    .month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0;
      border: 1px solid #dadce0;
      border-top: none;
    }

    .month-day {
      min-height: 120px;
      border-right: 1px solid #dadce0;
      border-bottom: 1px solid #dadce0;
      padding: 8px;
      background: #fff;
      cursor: pointer;
      position: relative;
    }

    .month-day:nth-child(7n) {
      border-right: none;
    }

    .month-day:hover {
      background: #f8f9fa;
    }

    .month-day.other-month {
      background: #fafafa;
    }

    .month-day.other-month .month-day-number {
      color: #dadce0;
    }

    .month-day-number {
      font-size: 12px;
      color: #3c4043;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .month-day-number.today {
      background: #1a73e8;
      color: #fff;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .month-event {
      padding: 2px 6px;
      margin-bottom: 2px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      border-left: 3px solid;
    }

    .month-event:hover {
      opacity: 0.8;
    }

    /* AI Chat Floating */
    .chat-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #1a73e8;
      color: #fff;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 4px 12px rgba(0,0,0,0.14);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: all 0.2s;
    }

    .chat-fab:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 8px 16px rgba(0,0,0,0.2);
      transform: scale(1.05);
    }

    /* Chat Window */
    .chat-window {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 380px;
      height: 550px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.24);
      display: none;
      flex-direction: column;
      z-index: 1001;
      overflow: hidden;
    }

    .chat-window.active {
      display: flex;
    }

    .chat-header {
      background: #1a73e8;
      color: #fff;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-title {
      font-size: 16px;
      font-weight: 500;
    }

    .chat-close-btn {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 20px;
      padding: 4px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      padding: 10px 14px;
      border-radius: 18px;
      max-width: 80%;
      font-size: 14px;
      line-height: 1.4;
    }

    .message.user {
      background: #1a73e8;
      color: #fff;
      align-self: flex-end;
      margin-left: auto;
    }

    .message.assistant {
      background: #f1f3f4;
      color: #3c4043;
      align-self: flex-start;
    }

    .chat-input-container {
      border-top: 1px solid #dadce0;
      padding: 12px;
    }

    .chat-input-box {
      display: flex;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #dadce0;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
    }

    .chat-input:focus {
      border-color: #1a73e8;
    }

    .mic-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #fff;
      border: 1px solid #dadce0;
      color: #5f6368;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .mic-btn:hover {
      background: #f8f9fa;
      border-color: #1a73e8;
      color: #1a73e8;
    }

    .mic-btn.recording {
      background: #ea4335;
      color: white;
      border-color: #ea4335;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #1a73e8;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-btn:hover {
      background: #1765cc;
    }

    .send-btn:disabled {
      background: #dadce0;
      cursor: not-allowed;
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: #f1f3f4;
      border-radius: 18px;
      max-width: 80px;
      align-self: flex-start;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #5f6368;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    /* Event Modal */
    .event-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .event-modal.active {
      display: flex;
    }

    .event-modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    /* Weather Detail Modal */
    .weather-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2001;
    }

    .weather-modal.active {
      display: flex;
    }

    .weather-modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 28px;
      max-width: 450px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .weather-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #f1f3f4;
      padding-bottom: 12px;
    }

    .weather-title {
      font-size: 22px;
      font-weight: 600;
      color: #1a73e8;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .weather-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .weather-info-item {
      background: #f8f9fa;
      padding: 14px;
      border-radius: 10px;
      text-align: center;
    }

    .weather-info-label {
      font-size: 12px;
      color: #70757a;
      margin-bottom: 6px;
      text-transform: uppercase;
      font-weight: 500;
    }

    .weather-info-value {
      font-size: 20px;
      font-weight: 600;
      color: #3c4043;
    }

    .weather-recommendation {
      margin-top: 20px;
      padding: 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
    }

    .weather-recommendation.suitable {
      background: #e6f4ea;
      color: #137333;
      border: 2px solid #34a853;
    }

    .weather-recommendation.unsuitable {
      background: #fce8e6;
      color: #c5221f;
      border: 2px solid #ea4335;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #1a73e8;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #5f6368;
      cursor: pointer;
      padding: 4px;
    }

    .modal-close:hover {
      color: #1a73e8;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #3c4043;
      margin-bottom: 6px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #dadce0;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 24px;
      justify-content: flex-end;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #1a73e8;
      color: #fff;
    }

    .btn-primary:hover {
      background: #1765cc;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
    }

    .btn-secondary {
      background: #f1f3f4;
      color: #3c4043;
    }

    .btn-secondary:hover {
      background: #e8eaed;
    }

    .btn-danger {
      background: #ea4335;
      color: #fff;
    }

    .btn-danger:hover {
      background: #d33828;
      box-shadow: 0 2px 8px rgba(234, 67, 53, 0.3);
    }

    /* Day View */
    .day-view-grid {
      display: grid;
      grid-template-columns: 60px 1fr;
      gap: 0;
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      overflow: hidden;
    }

    .hour-label {
      padding: 10px;
      text-align: right;
      font-size: 12px;
      color: #70757a;
      border-bottom: 1px solid #f1f3f4;
      background: #fafafa;
    }

    .hour-cell {
      border-bottom: 1px solid #f1f3f4;
      min-height: 60px;
      position: relative;
      cursor: pointer;
    }

    .hour-cell:hover {
      background: #f8f9fa;
    }

    .day-event {
      position: absolute;
      left: 2px;
      right: 2px;
      background: #e8f0fe;
      border-left: 3px solid #1a73e8;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 12px;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .day-event:hover {
      background: #d2e3fc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Year View */
    .year-view-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .year-month {
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 12px;
    }

    .year-month-title {
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 8px;
      color: #3c4043;
    }

    .year-month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      font-size: 11px;
    }

    .year-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 50%;
    }

    .year-day:hover {
      background: #f1f3f4;
    }

    .year-day.has-events {
      background: #e8f0fe;
      font-weight: 600;
    }

    .year-day.today {
      background: #1a73e8;
      color: #fff;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <span>üìÖ</span>
        <span>Kalend√°r</span>
      </div>
      <select class="calendar-selector" id="calendarSelector" onchange="changeCalendar()">
        <option value="">Naƒç√≠tavam...</option>
      </select>
    </div>
    <div class="header-right">
      <button class="icon-btn" onclick="refreshEvents()" title="Obnovi≈•">üîÑ</button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <button class="create-btn" onclick="showCreateEventDialog()">
        <span style="font-size: 20px;">‚ûï</span>
        <span>Vytvori≈•</span>
      </button>

      <!-- Mini Calendar -->
      <div class="mini-calendar">
        <div class="mini-calendar-header">
          <button class="mini-nav-btn" onclick="prevMonth()">‚Äπ</button>
          <span id="miniMonthYear"></span>
          <button class="mini-nav-btn" onclick="nextMonth()">‚Ä∫</button>
        </div>
        <div class="mini-calendar-grid" id="miniCalendarGrid"></div>
      </div>

      <!-- Calendars List -->
      <div class="calendars-list">
        <div class="calendars-title">Moje kalend√°re</div>
        <div id="calendarsList"></div>
      </div>
    </div>

    <!-- Calendar View -->
    <div class="calendar-view">
      <div class="calendar-controls">
        <div class="view-controls">
          <button class="view-btn" onclick="setViewMode('day')">De≈à</button>
          <button class="view-btn" onclick="setViewMode('week')">T√Ω≈æde≈à</button>
          <button class="view-btn active" onclick="setViewMode('month')">Mesiac</button>
          <button class="view-btn" onclick="setViewMode('year')">Rok</button>
        </div>

        <div class="nav-controls">
          <button class="nav-btn" onclick="prevPeriod()">‚Äπ</button>
          <span class="current-period" id="currentPeriod"></span>
          <button class="nav-btn" onclick="nextPeriod()">‚Ä∫</button>
          <button class="today-btn" onclick="goToToday()">Dnes</button>
        </div>
      </div>

      <div class="calendar-grid-container">
        <div class="weekday-headers" id="weekdayHeaders">
          <div class="weekday-header">Ned</div>
          <div class="weekday-header">Pon</div>
          <div class="weekday-header">Uto</div>
          <div class="weekday-header">Str</div>
          <div class="weekday-header">≈†tv</div>
          <div class="weekday-header">Pia</div>
          <div class="weekday-header">Sob</div>
        </div>
        <div id="calendarGrid"></div>
      </div>
    </div>
  </div>

  <!-- Chat FAB -->
  <button class="chat-fab" id="chatFab" onclick="toggleChat()">üí¨</button>

  <!-- Chat Window -->
  <div class="chat-window" id="chatWindow">
    <div class="chat-header">
      <div class="chat-title">ü§ñ AI Asistent</div>
      <button class="chat-close-btn" onclick="toggleChat()">√ó</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="message assistant">
        Ahoj! Som tvoj AI asistent. M√¥≈æem ti pom√¥c≈• s kalend√°rom:
        <br><br>
        ‚Ä¢ Vytvori≈• udalos≈•<br>
        ‚Ä¢ Zobrazi≈• udalosti<br>
        ‚Ä¢ Upravi≈• term√≠ny<br>
        ‚Ä¢ Pl√°nova≈• z√°kazky
      </div>
    </div>
    <div class="chat-input-container">
      <div class="chat-input-box">
        <input 
          type="text" 
          class="chat-input" 
          id="chatInput" 
          placeholder="Sp√Ωtaj sa ma na ƒçokoƒævek..."
          onkeypress="if(event.key==='Enter') sendMessage()"
        >
        <button class="mic-btn" id="micBtn" onclick="toggleVoiceRecognition()" title="Hlasov√© zad√°vanie (slovenƒçina)">
          üé§
        </button>
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <script>
    const scriptUrl = localStorage.getItem('scriptUrl');
    if (!scriptUrl) {
      window.location.href = '/connect.html';
    }

    let calendars = [];
    let events = [];
    let weather = { current: null, forecast: [] };
    let currentCalendarId = '';
    let currentDate = new Date();
    let viewMode = 'month';
    const sessionId = 'session_' + Date.now();
    let visibleCalendars = new Set(); // Sledovanie viditeƒæn√Ωch kalend√°rov
    let calendarColors = new Map(); // Sledovanie farieb kalend√°rov

    const skMonths = ['janu√°r', 'febru√°r', 'marec', 'apr√≠l', 'm√°j', 'j√∫n', 'j√∫l', 'august', 'september', 'okt√≥ber', 'november', 'december'];

    // Initialize
    async function init() {
      console.log('üöÄ Kalend√°r inicializ√°cia - verzia 5.1 (auto-send po hlasovom zadan√≠)');
      await loadCalendars();
      await loadEvents();
      await loadWeather();
      render(); // Re-render after weather is loaded
      renderMiniCalendar();
      
      // Setup event form listener
      const eventForm = document.getElementById('eventForm');
      if (eventForm) {
        eventForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const eventId = document.getElementById('eventId').value;
          const title = document.getElementById('eventTitle').value;
          const calendarId = document.getElementById('eventCalendar').value;
          const date = document.getElementById('eventDate').value;
          const allDay = document.getElementById('eventAllDay').checked;
          const startTime = document.getElementById('eventStartTime').value;
          const endTime = document.getElementById('eventEndTime').value;
          const location = document.getElementById('eventLocation').value;
          const description = document.getElementById('eventDescription').value;
          
          const startDateTime = allDay ? `${date}T00:00:00` : `${date}T${startTime}:00`;
          const endDateTime = allDay ? `${date}T23:59:59` : `${date}T${endTime}:00`;
          
          try {
            const response = await fetch('/api/create-event', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                calendarId: calendarId,
                summary: title,
                description: description,
                start: startDateTime,
                end: endDateTime,
                location: location
              })
            });
            
            const data = await response.json();
            
            if (data.ok) {
              closeEventModal();
              await loadEvents();
              render();
              addChatMessage('assistant', `‚úÖ Udalos≈• "${title}" bola vytvoren√°!`);
            } else {
              alert('Chyba: ' + (data.error || 'Nepodarilo sa vytvori≈• udalos≈•'));
            }
          } catch (error) {
            console.error('Error creating event:', error);
            alert('Chyba pri vytv√°ran√≠ udalosti');
          }
        });
      }
    }

    // Load calendars
    async function loadCalendars() {
      try {
        const url = new URL(scriptUrl);
        url.searchParams.append('action', 'getCalendars');
        
        const response = await fetch(url.toString());
        const data = await response.json();
        
        if (data.ok && data.calendars) {
          calendars = data.calendars;
          
          const selector = document.getElementById('calendarSelector');
          selector.innerHTML = `<option value="">üìÖ V≈°etky kalend√°re (${calendars.length})</option>` +
            calendars.map(cal => `<option value="${cal.id}">üìå ${cal.name}</option>`).join('');
          
          // Render calendars list
          const listDiv = document.getElementById('calendarsList');
          listDiv.innerHTML = calendars.map((cal, idx) => {
            const color = getCalendarColor(idx);
            calendarColors.set(cal.id, color);
            visibleCalendars.add(cal.id); // Defaultne v≈°etky zapnut√©
            
            return `
              <div class="calendar-item" onclick="toggleCalendarVisibility('${cal.id}', event)">
                <input type="checkbox" class="calendar-checkbox" id="cal_${cal.id}" checked onchange="toggleCalendarVisibility('${cal.id}', event)">
                <span class="calendar-color" style="background: ${color}"></span>
                <span>${cal.name}</span>
              </div>
            `;
          }).join('');
          
          if (calendars.length > 0) {
            currentCalendarId = calendars[0].id;
            selector.value = currentCalendarId;
          }
        }
      } catch (error) {
        console.error('Error loading calendars:', error);
      }
    }

    // Load weather
    async function loadWeather() {
      try {
        // First, get user's location
        const geoResponse = await fetch('/api/geolocation');
        const geoData = await geoResponse.json();
        
        console.log('üìç Geolok√°cia:', geoData);
        
        // Then fetch weather for that location
        let weatherUrl = '/api/weather?days=14';
        if (geoData.ok && geoData.latitude && geoData.longitude) {
          weatherUrl += `&lat=${geoData.latitude}&lon=${geoData.longitude}`;
        }
        
        const response = await fetch(weatherUrl);
        const data = await response.json();
        
        if (data.ok) {
          weather = data;
          console.log(`üå§Ô∏è Poƒçasie naƒç√≠tan√© pre ${data.location || geoData.city}:`, weather);
          
          // Display location in header (optional)
          if (data.location) {
            const periodEl = document.getElementById('currentPeriod');
            const originalText = periodEl.textContent;
            periodEl.title = `Poƒçasie: ${data.location}`;
          }
        }
      } catch (error) {
        console.error('Error loading weather:', error);
      }
    }

    // Get weather for specific date
    function getWeatherForDate(date) {
      if (!weather || !weather.forecast || weather.forecast.length === 0) {
        console.log('‚ö†Ô∏è Poƒçasie nie je k dispoz√≠cii:', weather);
        return null;
      }
      
      const dateStr = date.toDateString();
      const found = weather.forecast.find(f => new Date(f.date).toDateString() === dateStr);
      
      if (!found) {
        console.log(`‚ö†Ô∏è Poƒçasie pre ${dateStr} nen√°jden√©. Dostupn√©:`, weather.forecast.map(f => new Date(f.date).toDateString()));
      }
      
      return found;
    }

    // Get weather icon
    function getWeatherIcon(condition) {
      const icons = {
        'clear': '‚òÄÔ∏è',
        'clouds': '‚òÅÔ∏è',
        'rain': 'üåßÔ∏è',
        'drizzle': 'üå¶Ô∏è',
        'thunderstorm': '‚õàÔ∏è',
        'snow': '‚ùÑÔ∏è',
        'mist': 'üå´Ô∏è',
        'fog': 'üå´Ô∏è'
      };
      return icons[condition] || 'üå§Ô∏è';
    }

    // Get wind direction arrow
    function getWindDirection(degrees) {
      const directions = ['‚Üì', '‚Üô', '‚Üê', '‚Üñ', '‚Üë', '‚Üó', '‚Üí', '‚Üò'];
      const index = Math.round(((degrees % 360) / 45)) % 8;
      return directions[index];
    }

    // Get wind speed text
    function getWindSpeedText(speed) {
      const kmh = Math.round(speed * 3.6); // m/s to km/h
      if (kmh < 5) return 'slab√Ω';
      if (kmh < 15) return 'mierny';
      if (kmh < 25) return 'ƒçerstv√Ω';
      if (kmh < 40) return 'siln√Ω';
      return 'b√∫rliv√Ω';
    }

    // Get weather background color
    function getWeatherBackground(condition, suitable_for_installation) {
      if (suitable_for_installation) {
        return 'rgba(102, 126, 234, 0.15)'; // Nice weather - light blue
      } else {
        return 'rgba(245, 87, 108, 0.15)'; // Bad weather - light red
      }
    }

    function getCalendarColor(index) {
      const colors = ['#1a73e8', '#e67c73', '#33b679', '#f4b400', '#f439a0', '#7baaf7', '#b39ddb', '#4285f4', '#ea4335', '#34a853', '#fbbc04'];
      return colors[index % colors.length];
    }

    function toggleCalendarVisibility(calendarId, event) {
      // Zabr√°≈à double-trigger (click na div + change na checkbox)
      if (event.target.tagName === 'INPUT') {
        event.stopPropagation();
      }
      
      const checkbox = document.getElementById('cal_' + calendarId);
      
      if (event.target.tagName !== 'INPUT') {
        checkbox.checked = !checkbox.checked;
      }
      
      if (checkbox.checked) {
        visibleCalendars.add(calendarId);
      } else {
        visibleCalendars.delete(calendarId);
      }
      
      console.log('üëÅÔ∏è Viditeƒæn√© kalend√°re:', Array.from(visibleCalendars));
      render();
    }

    // Load events
    async function loadEvents() {
      try {
        console.log('üìÖ Naƒç√≠tavam udalosti...');
        const url = new URL(scriptUrl);
        url.searchParams.append('action', 'getEvents');
        
        // Naƒç√≠taj zo v≈°etk√Ωch kalend√°rov, nie len z jedn√©ho
        url.searchParams.append('allCalendars', 'true');
        url.searchParams.append('maxResults', '200');
        url.searchParams.append('daysAhead', '60');
        
        console.log('üîó URL:', url.toString());
        
        const response = await fetch(url.toString());
        const data = await response.json();
        
        console.log('üì¶ Odpoveƒè:', data);
        
        if (data.ok && data.events) {
          events = data.events.map(e => ({
            ...e,
            start: new Date(e.start.dateTime || e.start.date),
            end: new Date(e.end.dateTime || e.end.date),
            color: e.backgroundColor || '#1a73e8'
          }));
          console.log(`‚úÖ Naƒç√≠tan√Ωch ${events.length} udalost√≠`);
        } else {
          console.warn('‚ö†Ô∏è ≈Ωiadne udalosti alebo chyba:', data);
        }
      } catch (error) {
        console.error('‚ùå Error loading events:', error);
        alert('Chyba pri naƒç√≠tan√≠ udalost√≠: ' + error.message);
      }
    }

    // Change calendar
    async function changeCalendar() {
      const selector = document.getElementById('calendarSelector');
      currentCalendarId = selector.value;
      await loadEvents();
      render();
    }

    // Refresh
    async function refreshEvents() {
      await loadEvents();
      render();
    }

    // Navigation
    function prevPeriod() {
      if (viewMode === 'day') {
        currentDate.setDate(currentDate.getDate() - 1);
      } else if (viewMode === 'week') {
        currentDate.setDate(currentDate.getDate() - 7);
      } else if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else if (viewMode === 'year') {
        currentDate.setFullYear(currentDate.getFullYear() - 1);
      }
      render();
      renderMiniCalendar();
    }

    function nextPeriod() {
      if (viewMode === 'day') {
        currentDate.setDate(currentDate.getDate() + 1);
      } else if (viewMode === 'week') {
        currentDate.setDate(currentDate.getDate() + 7);
      } else if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else if (viewMode === 'year') {
        currentDate.setFullYear(currentDate.getFullYear() + 1);
      }
      render();
      renderMiniCalendar();
    }

    function prevMonth() {
      prevPeriod();
    }

    function nextMonth() {
      nextPeriod();
    }

    function goToToday() {
      currentDate = new Date();
      render();
      renderMiniCalendar();
    }

    // Set view mode
    function setViewMode(mode) {
      viewMode = mode;
      
      // Update button states
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      render();
    }

    // Render calendar
    function render() {
      console.log('üé® Renderujem kalend√°r...', { eventsCount: events.length, currentDate, viewMode });
      
      if (viewMode === 'day') {
        renderDayView();
      } else if (viewMode === 'week') {
        renderWeekView();
      } else if (viewMode === 'month') {
        renderMonthView();
      } else if (viewMode === 'year') {
        renderYearView();
      }
    }

    // Day View
    function renderDayView() {
      const dayWeather = getWeatherForDate(currentDate);
      const weatherIcon = dayWeather ? getWeatherIcon(dayWeather.condition) : '';
      const windInfo = dayWeather && dayWeather.wind_speed ? 
        `${getWindDirection(dayWeather.wind_deg)} ${Math.round(dayWeather.wind_speed * 3.6)} km/h (${getWindSpeedText(dayWeather.wind_speed)})` : '';
      const weatherDesc = dayWeather ? 
        `${weatherIcon} ${Math.round(dayWeather.temperature)}¬∞C - ${dayWeather.description}${windInfo ? `, vietor: ${windInfo}` : ''}` : '';
      
      document.getElementById('currentPeriod').textContent = 
        `${currentDate.toLocaleDateString('sk-SK', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`;
      
      if (weatherDesc) {
        document.getElementById('currentPeriod').innerHTML = 
          `${currentDate.toLocaleDateString('sk-SK', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}<br>
           <span style="font-size:14px;color:#70757a;font-weight:400;">${weatherDesc}</span>`;
      }
      
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      grid.className = 'day-view-grid';
      
      // Hide weekday headers
      document.getElementById('weekdayHeaders').style.display = 'none';
      
      // Apply weather background to calendar
      if (dayWeather) {
        grid.style.background = getWeatherBackground(dayWeather.condition, dayWeather.suitable_for_installation);
      }
      
      // Working hours 8-18
      for (let hour = 8; hour <= 18; hour++) {
        const hourLabel = document.createElement('div');
        hourLabel.className = 'hour-label';
        hourLabel.textContent = `${hour}:00`;
        grid.appendChild(hourLabel);
        
        const hourCell = document.createElement('div');
        hourCell.className = 'hour-cell';
        hourCell.onclick = () => openEventModal(new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), hour, 0));
        
        // Find events for this hour
        const hourEvents = events.filter(e => {
          if (!visibleCalendars.has(e.calendarId)) return false;
          
          const eventDate = new Date(e.start);
          const eventHour = eventDate.getHours();
          const sameDay = eventDate.toDateString() === currentDate.toDateString();
          return sameDay && eventHour === hour;
        });
        
        hourEvents.forEach(e => {
          const eventEl = document.createElement('div');
          eventEl.className = 'day-event';
          eventEl.textContent = e.summary || e.title;
          eventEl.style.borderLeftColor = calendarColors.get(e.calendarId) || '#1a73e8';
          eventEl.onclick = (evt) => {
            evt.stopPropagation();
            openEventModal(null, e);
          };
          hourCell.appendChild(eventEl);
        });
        
        grid.appendChild(hourCell);
      }
    }

    // Week View
    function renderWeekView() {
      // Get start of week (Monday)
      const startOfWeek = new Date(currentDate);
      const day = startOfWeek.getDay();
      const diff = day === 0 ? -6 : 1 - day; // If Sunday (0), go back 6 days, else go to Monday
      startOfWeek.setDate(startOfWeek.getDate() + diff);
      startOfWeek.setHours(0,0,0,0);
      
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(endOfWeek.getDate() + 6);
      
      // Update period text
      const startDay = startOfWeek.getDate();
      const endDay = endOfWeek.getDate();
      const startMonth = skMonths[startOfWeek.getMonth()];
      const endMonth = skMonths[endOfWeek.getMonth()];
      
      if (startOfWeek.getMonth() === endOfWeek.getMonth()) {
        document.getElementById('currentPeriod').textContent = 
          `${startDay}‚Äì${endDay} ${startMonth} ${startOfWeek.getFullYear()}`;
      } else {
        document.getElementById('currentPeriod').textContent = 
          `${startDay} ${startMonth} ‚Äì ${endDay} ${endMonth} ${startOfWeek.getFullYear()}`;
      }
      
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      grid.className = 'week-view-grid';
      
      // Show custom week headers
      const headers = document.getElementById('weekdayHeaders');
      headers.style.display = 'grid';
      headers.style.gridTemplateColumns = '60px repeat(7, 1fr)';
      headers.innerHTML = '<div></div>'; // Empty corner
      
      const dayNames = ['Ned', 'Pon', 'Uto', 'Str', '≈†tv', 'Pia', 'Sob'];
      const today = new Date();
      today.setHours(0,0,0,0);
      
      // Day headers with dates
      for (let i = 0; i < 7; i++) {
        const dayDate = new Date(startOfWeek);
        dayDate.setDate(dayDate.getDate() + i);
        const dayNum = dayDate.getDay();
        const isToday = dayDate.getTime() === today.getTime();
        
        // Get weather for this day
        const dayWeather = getWeatherForDate(dayDate);
        const weatherIcon = dayWeather ? getWeatherIcon(dayWeather.condition) : '';
        const weatherTemp = dayWeather ? `${Math.round(dayWeather.temperature)}¬∞C` : '';
        const windInfo = dayWeather && dayWeather.wind_speed ? `${getWindDirection(dayWeather.wind_deg)} ${Math.round(dayWeather.wind_speed * 3.6)}km/h` : '';
        
        const header = document.createElement('div');
        header.className = 'weekday-header';
        header.style.background = dayWeather ? getWeatherBackground(dayWeather.condition, dayWeather.suitable_for_installation) : 'transparent';
        header.innerHTML = `
          <div style="font-size:11px;color:#70757a;">${dayNames[dayNum]}</div>
          <div style="font-size:18px;font-weight:${isToday ? '600' : '400'};color:${isToday ? '#1a73e8' : '#3c4043'};">
            ${dayDate.getDate()}
          </div>
          ${weatherIcon ? `<div style="font-size:16px;margin-top:4px;">${weatherIcon}</div>` : ''}
          ${weatherTemp ? `<div style="font-size:10px;color:#70757a;">${weatherTemp}</div>` : ''}
          ${windInfo ? `<div style="font-size:10px;color:#70757a;margin-top:2px;">${windInfo}</div>` : ''}
        `;
        headers.appendChild(header);
      }
      
      // Working hours 8-18
      for (let hour = 8; hour <= 18; hour++) {
        // Hour label
        const hourLabel = document.createElement('div');
        hourLabel.className = 'hour-label';
        hourLabel.textContent = `${hour}:00`;
        hourLabel.style.textAlign = 'right';
        hourLabel.style.padding = '10px';
        hourLabel.style.fontSize = '12px';
        hourLabel.style.color = '#70757a';
        hourLabel.style.borderBottom = '1px solid #f1f3f4';
        hourLabel.style.background = '#fafafa';
        grid.appendChild(hourLabel);
        
        // Day cells for this hour
        for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
          const cellDate = new Date(startOfWeek);
          cellDate.setDate(cellDate.getDate() + dayOffset);
          cellDate.setHours(hour, 0, 0, 0);
          
          const hourCell = document.createElement('div');
          hourCell.className = 'hour-cell';
          hourCell.style.borderBottom = '1px solid #f1f3f4';
          hourCell.style.borderLeft = '1px solid #f1f3f4';
          hourCell.style.minHeight = '60px';
          hourCell.style.position = 'relative';
          hourCell.style.cursor = 'pointer';
          
          hourCell.onclick = () => openEventModal(new Date(cellDate), null);
          
          // Find events for this hour and day
          const hourEvents = events.filter(e => {
            if (!visibleCalendars.has(e.calendarId)) return false;
            
            const eventDate = new Date(e.start);
            const eventHour = eventDate.getHours();
            const sameDay = eventDate.toDateString() === cellDate.toDateString();
            return sameDay && eventHour === hour;
          });
          
          hourEvents.forEach(e => {
            const eventEl = document.createElement('div');
            eventEl.className = 'day-event';
            eventEl.textContent = e.summary || e.title;
            eventEl.style.position = 'absolute';
            eventEl.style.left = '2px';
            eventEl.style.right = '2px';
            eventEl.style.top = '2px';
            eventEl.style.background = '#e8f0fe';
            eventEl.style.borderLeft = '3px solid ' + (calendarColors.get(e.calendarId) || '#1a73e8');
            eventEl.style.borderRadius = '4px';
            eventEl.style.padding = '4px 6px';
            eventEl.style.fontSize = '12px';
            eventEl.style.cursor = 'pointer';
            eventEl.style.overflow = 'hidden';
            eventEl.style.textOverflow = 'ellipsis';
            eventEl.style.whiteSpace = 'nowrap';
            
            eventEl.onclick = (evt) => {
              evt.stopPropagation();
              openEventModal(null, e);
            };
            
            eventEl.onmouseover = () => {
              eventEl.style.background = '#d2e3fc';
              eventEl.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            };
            
            eventEl.onmouseout = () => {
              eventEl.style.background = '#e8f0fe';
              eventEl.style.boxShadow = 'none';
            };
            
            hourCell.appendChild(eventEl);
          });
          
          // Hover effect
          hourCell.onmouseover = () => {
            if (hourEvents.length === 0) {
              hourCell.style.background = '#f8f9fa';
            }
          };
          
          hourCell.onmouseout = () => {
            hourCell.style.background = 'transparent';
          };
          
          grid.appendChild(hourCell);
        }
      }
      
      // Set grid layout
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = '60px repeat(7, 1fr)';
      grid.style.border = '1px solid #dadce0';
      grid.style.borderRadius = '8px';
      grid.style.overflow = 'hidden';
      grid.style.background = '#fff';
    }

    // Month View (existing logic)
    function renderMonthView() {
      document.getElementById('currentPeriod').textContent = 
        `${skMonths[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

      const grid = document.getElementById('calendarGrid');
      grid.className = 'month-grid';
      grid.style = ''; // Reset inline styles
      
      // Reset and show weekday headers
      const headers = document.getElementById('weekdayHeaders');
      headers.style.display = 'grid';
      headers.style.gridTemplateColumns = 'repeat(7, 1fr)';
      headers.innerHTML = `
        <div class="weekday-header">Ned</div>
        <div class="weekday-header">Pon</div>
        <div class="weekday-header">Uto</div>
        <div class="weekday-header">Str</div>
        <div class="weekday-header">≈†tv</div>
        <div class="weekday-header">Pia</div>
        <div class="weekday-header">Sob</div>
      `;
      
      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - startDate.getDay());
      
      const endDate = new Date(lastDay);
      endDate.setDate(endDate.getDate() + (6 - endDate.getDay()));
      
      let html = '';
      const today = new Date();
      today.setHours(0,0,0,0);
      
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const isToday = d.getTime() === today.getTime();
        const isOtherMonth = d.getMonth() !== currentDate.getMonth();
        const dayDate = new Date(d);
        
        // Get weather for this day
        const dayWeather = getWeatherForDate(dayDate);
        const weatherIcon = dayWeather ? getWeatherIcon(dayWeather.condition) : '';
        const weatherBg = dayWeather ? getWeatherBackground(dayWeather.condition, dayWeather.suitable_for_installation) : '';
        const weatherTemp = dayWeather ? `${Math.round(dayWeather.temperature)}¬∞C` : '';
        const windInfo = dayWeather && dayWeather.wind_speed ? `${getWindDirection(dayWeather.wind_deg)} ${Math.round(dayWeather.wind_speed * 3.6)}km/h` : '';
        
        const dayEvents = events.filter(e => {
          const eventDate = new Date(e.start);
          eventDate.setHours(0,0,0,0);
          const checkDate = new Date(d);
          checkDate.setHours(0,0,0,0);
          
          const isDateMatch = eventDate.getTime() === checkDate.getTime();
          const isCalendarVisible = visibleCalendars.has(e.calendarId);
          
          return isDateMatch && isCalendarVisible;
        });
        
        html += `
          <div class="month-day ${isOtherMonth ? 'other-month' : ''}" onclick="openEventModal(new Date(${dayDate.getTime()}), null)" style="background: ${weatherBg}; position: relative;">
            <div class="month-day-number ${isToday ? 'today' : ''}">
              ${d.getDate()} ${weatherIcon ? `<span style="font-size:14px;margin-left:4px;">${weatherIcon}</span>` : ''}
            </div>
            ${weatherTemp || windInfo ? `
              <div onclick="event.stopPropagation(); openWeatherModal(new Date(${dayDate.getTime()}))" style="position: absolute; top: 4px; right: 4px; font-size: 10px; color: #5f6368; text-align: right; line-height: 1.3; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.08)'" onmouseout="this.style.background='transparent'">
                ${weatherTemp ? `<div style="font-weight: 500;">${weatherTemp}</div>` : ''}
                ${windInfo ? `<div style="margin-top: 2px;">${windInfo}</div>` : ''}
              </div>
            ` : ''}
            ${dayEvents.slice(0, 3).map((e, idx) => {
              const color = calendarColors.get(e.calendarId) || '#1a73e8';
              const globalEventIndex = events.indexOf(e);
              return `
                <div class="month-event" style="border-left-color: ${color}; background: ${color}20" onclick="event.stopPropagation(); openEventModalByIndex(${globalEventIndex})">
                  ${e.summary || e.title}
                </div>
              `;
            }).join('')}
            ${dayEvents.length > 3 ? `<div style="font-size:11px;color:#5f6368;">+${dayEvents.length - 3} ƒèal≈°√≠ch</div>` : ''}
          </div>
        `;
      }
      
      grid.innerHTML = html;
      console.log('‚úÖ Kalend√°r renderovan√Ω');
    }

    // Year View
    function renderYearView() {
      document.getElementById('currentPeriod').textContent = currentDate.getFullYear().toString();
      
      const grid = document.getElementById('calendarGrid');
      grid.className = 'year-view-grid';
      grid.innerHTML = '';
      
      // Hide weekday headers
      document.getElementById('weekdayHeaders').style.display = 'none';
      
      const today = new Date();
      today.setHours(0,0,0,0);
      
      for (let month = 0; month < 12; month++) {
        const monthDiv = document.createElement('div');
        monthDiv.className = 'year-month';
        
        const title = document.createElement('div');
        title.className = 'year-month-title';
        title.textContent = skMonths[month];
        monthDiv.appendChild(title);
        
        const monthGrid = document.createElement('div');
        monthGrid.className = 'year-month-grid';
        
        // Day headers
        ['N','P','U','S','≈†','P','S'].forEach(d => {
          const header = document.createElement('div');
          header.className = 'mini-day-header';
          header.textContent = d;
          monthGrid.appendChild(header);
        });
        
        const firstDay = new Date(currentDate.getFullYear(), month, 1);
        const lastDay = new Date(currentDate.getFullYear(), month + 1, 0);
        
        // Empty cells before month starts
        for (let i = 0; i < firstDay.getDay(); i++) {
          monthGrid.appendChild(document.createElement('div'));
        }
        
        // Days of month
        for (let day = 1; day <= lastDay.getDate(); day++) {
          const date = new Date(currentDate.getFullYear(), month, day);
          const hasEvents = events.some(e => {
            const eventDate = new Date(e.start);
            eventDate.setHours(0,0,0,0);
            date.setHours(0,0,0,0);
            return eventDate.getTime() === date.getTime() && visibleCalendars.has(e.calendarId);
          });
          
          const dayEl = document.createElement('div');
          dayEl.className = 'year-day';
          if (date.getTime() === today.getTime()) dayEl.classList.add('today');
          if (hasEvents) dayEl.classList.add('has-events');
          dayEl.textContent = day;
          dayEl.onclick = () => {
            currentDate = new Date(currentDate.getFullYear(), month, day);
            viewMode = 'day';
            setViewMode('day');
          };
          
          monthGrid.appendChild(dayEl);
        }
        
        monthDiv.appendChild(monthGrid);
        grid.appendChild(monthDiv);
      }
    }

    // Mini calendar
    function renderMiniCalendar() {
      document.getElementById('miniMonthYear').textContent = 
        `${skMonths[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
      
      const grid = document.getElementById('miniCalendarGrid');
      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      
      const today = new Date();
      today.setHours(0,0,0,0);
      
      let html = ['N', 'P', 'U', 'S', '≈†', 'P', 'S'].map(d => 
        `<div class="mini-day-header">${d}</div>`
      ).join('');
      
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - startDate.getDay());
      
      const endDate = new Date(lastDay);
      endDate.setDate(endDate.getDate() + (6 - endDate.getDay()));
      
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const isToday = d.getTime() === today.getTime();
        const isOtherMonth = d.getMonth() !== currentDate.getMonth();
        
        html += `<div class="mini-day ${isToday ? 'today' : ''} ${isOtherMonth ? 'other-month' : ''}">${d.getDate()}</div>`;
      }
      
      grid.innerHTML = html;
    }

    // Show day events in chat
    function showDayEvents(dateStr) {
      const date = new Date(dateStr);
      const dayEvents = events.filter(e => {
        const eventDate = new Date(e.start);
        eventDate.setHours(0,0,0,0);
        date.setHours(0,0,0,0);
        
        // Filtruj aj podƒæa viditeƒænosti kalend√°ra
        const isDateMatch = eventDate.getTime() === date.getTime();
        const isCalendarVisible = visibleCalendars.has(e.calendarId);
        
        return isDateMatch && isCalendarVisible;
      });
      
      toggleChat(true);
      
      let message = `üìÖ **${date.toLocaleDateString('sk-SK', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}**\n\n`;
      
      if (dayEvents.length === 0) {
        message += '≈Ωiadne udalosti.';
      } else {
        message += dayEvents.map(e => {
          const time = e.start.toLocaleTimeString('sk-SK', { hour: '2-digit', minute: '2-digit' });
          const calendarName = calendars.find(c => c.id === e.calendarId)?.name || '';
          return `üïê ${time} - ${e.summary || e.title}${calendarName ? ` (${calendarName})` : ''}`;
        }).join('\n');
      }
      
      addChatMessage('assistant', message);
    }

    // Chat functionality
    function toggleChat(forceOpen = false) {
      const chatWindow = document.getElementById('chatWindow');
      const chatFab = document.getElementById('chatFab');
      
      if (forceOpen) {
        chatWindow.classList.add('active');
        chatFab.style.display = 'none';
      } else {
        chatWindow.classList.toggle('active');
        chatFab.style.display = chatWindow.classList.contains('active') ? 'none' : 'flex';
      }
    }

    // Voice Recognition
    let recognition = null;
    let isRecording = false;

    function initVoiceRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.warn('Web Speech API nie je podporovan√© v tomto prehliadaƒçi');
        return false;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      
      recognition.lang = 'sk-SK'; // Slovenƒçina
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        console.log('üé§ Nahr√°vanie spusten√©');
        isRecording = true;
        document.getElementById('micBtn').classList.add('recording');
      };

      recognition.onresult = (event) => {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }
        document.getElementById('chatInput').value = transcript;
      };

      recognition.onerror = (event) => {
        console.error('Chyba rozpozn√°vania reƒçi:', event.error);
        isRecording = false;
        document.getElementById('micBtn').classList.remove('recording');
        
        if (event.error === 'not-allowed') {
          alert('Pr√≠stup k mikrof√≥nu bol zamietnut√Ω. Povoƒæte pr√≠stup v nastaveniach prehliadaƒça.');
        }
      };

      recognition.onend = () => {
        console.log('üé§ Nahr√°vanie ukonƒçen√©');
        isRecording = false;
        document.getElementById('micBtn').classList.remove('recording');
        
        // Automaticky odo≈°li spr√°vu po ukonƒçen√≠ nahr√°vania
        const inputValue = document.getElementById('chatInput').value.trim();
        if (inputValue) {
          sendMessage();
        }
      };

      return true;
    }

    function toggleVoiceRecognition() {
      if (!recognition && !initVoiceRecognition()) {
        alert('Hlasov√© zad√°vanie nie je podporovan√© vo va≈°om prehliadaƒçi.\nPodpora: Chrome, Edge, Safari.');
        return;
      }

      if (isRecording) {
        recognition.stop();
      } else {
        document.getElementById('chatInput').value = ''; // Clear input
        recognition.start();
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;
      
      addChatMessage('user', message);
      input.value = '';
      
      // Zobraz typing indicator
      const typingId = showTypingIndicator();
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, sessionId })
        });
        
        // Odstr√°≈à typing indicator
        removeTypingIndicator(typingId);
        
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        const aiReply = data.response || data.error || 'Nepodarilo sa z√≠ska≈• odpoveƒè';
        
        addChatMessage('assistant', aiReply);
        
        if (aiReply.includes('vytvoren√°') || aiReply.includes('pridan√°')) {
          setTimeout(() => refreshEvents(), 1000);
        }
      } catch (error) {
        removeTypingIndicator(typingId);
        console.error('Chat error:', error);
        addChatMessage('assistant', '‚ùå Chyba: ' + error.message);
      }
    }

    function addChatMessage(role, text) {
      const messagesDiv = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${role}`;
      
      let formattedText = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
      
      msgDiv.innerHTML = formattedText;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTypingIndicator() {
      const messagesDiv = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      const id = 'typing_' + Date.now();
      typingDiv.id = id;
      typingDiv.className = 'typing-indicator';
      typingDiv.innerHTML = '<span></span><span></span><span></span>';
      messagesDiv.appendChild(typingDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      return id;
    }

    function removeTypingIndicator(id) {
      const typingDiv = document.getElementById(id);
      if (typingDiv) {
        typingDiv.remove();
      }
    }

    function showCreateEventDialog() {
      toggleChat(true);
      addChatMessage('assistant', 'Povedzmi, ak√∫ udalos≈• chce≈° vytvori≈•. Napr√≠klad: "Pridaj stretnutie zajtra o 14:00"');
    }

    // Modal functions
    function openEventModalByIndex(eventIndex) {
      if (eventIndex >= 0 && eventIndex < events.length) {
        openEventModal(null, events[eventIndex]);
      }
    }

    function openEventModal(date = null, event = null) {
      const modal = document.getElementById('eventModal');
      const form = document.getElementById('eventForm');
      const titleEl = document.getElementById('modalTitle');
      const deleteBtn = document.getElementById('deleteBtn');
      
      // Populate calendar dropdown
      const calendarSelect = document.getElementById('eventCalendar');
      calendarSelect.innerHTML = '<option value="">-- Vyberte kalend√°r --</option>' +
        calendars.map(cal => `<option value="${cal.id}">${cal.name}</option>`).join('');
      
      if (event) {
        // Edit mode
        titleEl.textContent = 'Upravi≈• udalos≈•';
        deleteBtn.style.display = 'block';
        
        document.getElementById('eventId').value = event.id;
        document.getElementById('eventTitle').value = event.summary || event.title;
        document.getElementById('eventCalendar').value = event.calendarId || '';
        document.getElementById('eventDate').value = event.start.toISOString().split('T')[0];
        document.getElementById('eventStartTime').value = event.start.toTimeString().slice(0,5);
        document.getElementById('eventEndTime').value = event.end.toTimeString().slice(0,5);
        document.getElementById('eventLocation').value = event.location || '';
        document.getElementById('eventDescription').value = event.description || '';
      } else {
        // Create mode
        titleEl.textContent = 'Nov√° udalos≈•';
        deleteBtn.style.display = 'none';
        form.reset();
        
        if (date) {
          document.getElementById('eventDate').value = date.toISOString().split('T')[0];
        }
        
        // Default calendar
        if (calendars.length > 0) {
          document.getElementById('eventCalendar').value = calendars[0].id;
        }
      }
      
      modal.classList.add('active');
    }

    function closeEventModal() {
      const modal = document.getElementById('eventModal');
      modal.classList.remove('active');
    }

    function openWeatherModal(date) {
      const modal = document.getElementById('weatherModal');
      const weatherData = getWeatherForDate(date);
      
      if (!weatherData) {
        alert('Poƒçasie pre tento de≈à nie je k dispoz√≠cii');
        return;
      }
      
      // Format date
      const dateStr = `${date.getDate()}. ${skMonths[date.getMonth()]} ${date.getFullYear()}`;
      document.getElementById('weatherModalDate').textContent = dateStr;
      document.getElementById('weatherModalIcon').textContent = getWeatherIcon(weatherData.condition);
      
      // Fill weather info
      document.getElementById('weatherTemp').textContent = `${Math.round(weatherData.temperature)}¬∞C`;
      document.getElementById('weatherDescription').textContent = weatherData.description || '--';
      document.getElementById('weatherWind').textContent = weatherData.wind_speed ? 
        `${Math.round(weatherData.wind_speed * 3.6)} km/h` : '--';
      document.getElementById('weatherWindDir').textContent = weatherData.wind_deg !== undefined ? 
        getWindDirection(weatherData.wind_deg) : '--';
      
      // Recommendation
      const recEl = document.getElementById('weatherRecommendation');
      const recText = document.getElementById('weatherRecommendationText');
      
      if (weatherData.suitable_for_installation) {
        recEl.className = 'weather-recommendation suitable';
        recText.innerHTML = `
          ‚úÖ <strong>Vhodn√© pre mont√°≈æ</strong><br>
          Poƒçasie je priazniv√© pre vonkaj≈°ie pr√°ce. Teplota je nad bodom mrazu, 
          vietor je slab√Ω a neoƒçak√°va sa zr√°≈æky.
        `;
      } else {
        recEl.className = 'weather-recommendation unsuitable';
        recText.innerHTML = `
          ‚ùå <strong>Nevhodn√© pre mont√°≈æ</strong><br>
          Poƒçasie nie je vhodn√© pre vonkaj≈°ie pr√°ce. Odpor√∫ƒçame v√Ωrobu v hale alebo 
          presun mont√°≈æe na in√Ω de≈à.
        `;
      }
      
      modal.classList.add('active');
    }

    function closeWeatherModal() {
      const modal = document.getElementById('weatherModal');
      modal.classList.remove('active');
    }

    function toggleTimeInputs() {
      const allDay = document.getElementById('eventAllDay').checked;
      const timeInputs = document.getElementById('timeInputs');
      timeInputs.style.display = allDay ? 'none' : 'grid';
    }

    async function deleteEvent() {
      const eventId = document.getElementById('eventId').value;
      
      if (!confirm('Naozaj chcete zmaza≈• t√∫to udalos≈•?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/delete-event`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eventId })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          closeEventModal();
          await loadEvents();
          render();
          addChatMessage('assistant', '‚úÖ Udalos≈• bola zmazan√°');
        } else {
          alert('Chyba: ' + (data.error || 'Nepodarilo sa zmaza≈• udalos≈•'));
        }
      } catch (error) {
        console.error('Error deleting event:', error);
        alert('Chyba pri mazan√≠ udalosti');
      }
    }

    // Initialize
    init();
  </script>

  <!-- Weather Detail Modal -->
  <div class="weather-modal" id="weatherModal">
    <div class="weather-modal-content">
      <div class="weather-header">
        <div class="weather-title" id="weatherModalTitle">
          <span id="weatherModalIcon">üå§Ô∏è</span>
          <span id="weatherModalDate">Poƒçasie</span>
        </div>
        <button class="modal-close" onclick="closeWeatherModal()">√ó</button>
      </div>
      
      <div class="weather-info-grid">
        <div class="weather-info-item">
          <div class="weather-info-label">Teplota</div>
          <div class="weather-info-value" id="weatherTemp">--¬∞C</div>
        </div>
        
        <div class="weather-info-item">
          <div class="weather-info-label">Pocit</div>
          <div class="weather-info-value" id="weatherDescription">--</div>
        </div>
        
        <div class="weather-info-item">
          <div class="weather-info-label">Vietor</div>
          <div class="weather-info-value" id="weatherWind">-- km/h</div>
        </div>
        
        <div class="weather-info-item">
          <div class="weather-info-label">Smer vetra</div>
          <div class="weather-info-value" id="weatherWindDir">--</div>
        </div>
      </div>
      
      <div class="weather-recommendation" id="weatherRecommendation">
        <div style="font-size: 16px; margin-bottom: 8px;">üìã Odpor√∫ƒçanie</div>
        <div id="weatherRecommendationText">--</div>
      </div>
    </div>
  </div>

  <!-- Event Creation/Edit Modal -->
  <div class="event-modal" id="eventModal">
    <div class="event-modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Nov√° udalos≈•</div>
        <button class="modal-close" onclick="closeEventModal()">√ó</button>
      </div>
      
      <form id="eventForm">
        <input type="hidden" id="eventId">
        
        <div class="form-group">
          <label class="form-label">N√°zov *</label>
          <input type="text" class="form-input" id="eventTitle" required>
        </div>

        <div class="form-group">
          <label class="form-label">Kalend√°r *</label>
          <select class="form-select" id="eventCalendar" required>
            <option value="">-- Vyberte kalend√°r --</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">D√°tum *</label>
            <input type="date" class="form-input" id="eventDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Celodenn</label>
            <input type="checkbox" id="eventAllDay" onchange="toggleTimeInputs()">
          </div>
        </div>

        <div class="form-row" id="timeInputs">
          <div class="form-group">
            <label class="form-label">Od</label>
            <input type="time" class="form-input" id="eventStartTime">
          </div>
          <div class="form-group">
            <label class="form-label">Do</label>
            <input type="time" class="form-input" id="eventEndTime">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Miesto</label>
          <input type="text" class="form-input" id="eventLocation">
        </div>

        <div class="form-group">
          <label class="form-label">Popis</label>
          <textarea class="form-textarea" id="eventDescription"></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteBtn" onclick="deleteEvent()" style="display:none; margin-right: auto;">
            Zmaza≈•
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeEventModal()">
            Zru≈°i≈•
          </button>
          <button type="submit" class="btn btn-primary">
            Ulo≈æi≈•
          </button>
        </div>
      </form>
    </div>
  </div>
</body>
</html>


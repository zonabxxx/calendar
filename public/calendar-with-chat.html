<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìÖ Kalend√°r + AI Asistent</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #2c3e50;
      height: 100vh;
      overflow: hidden;
    }

    /* Top Bar */
    .top-bar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 30px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.3);
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    }
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #404040;
      height: 70px;
    }

    .top-bar-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .calendar-selector {
      padding: 12px 20px;
      background: #ffffff;
      border: 2px solid #667eea;
      border-radius: 10px;
      color: #2c3e50;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      min-width: 300px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      transition: all 0.3s ease;
    }
    
    .calendar-selector:hover {
      border-color: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(118, 75, 162, 0.3);
    }
    
    .calendar-selector option {
      background: #ffffff;
      color: #2c3e50;
      padding: 10px;
      font-size: 16px;
    }

    .view-mode-btns {
      display: flex;
      gap: 10px;
    }

    .view-btn {
      padding: 8px 16px;
      background: #ffffff;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      color: #2c3e50;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .view-btn:hover {
      border-color: #667eea;
      transform: translateY(-1px);
    }

    .view-btn.active {
      background: #667eea;
      border-color: #667eea;
      color: #ffffff;
      box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
    }

    .nav-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .nav-btn {
      padding: 8px 16px;
      background: #ffffff;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      color: #2c3e50;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .nav-btn:hover {
      background: #f5f5f5;
      border-color: #667eea;
    }

    .current-period {
      font-size: 20px;
      font-weight: 600;
      min-width: 250px;
      text-align: center;
      color: #2c3e50;
    }

    .top-bar-right {
      display: flex;
      gap: 10px;
    }

    .icon-btn {
      padding: 10px;
      background: #ffffff;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      color: #667eea;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: #667eea;
      color: #ffffff;
      border-color: #667eea;
      transform: scale(1.05);
    }

    /* Main Container */
    .main-container {
      display: flex;
      height: calc(100vh - 70px);
      position: relative;
    }

    /* Calendar View */
    .calendar-view {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
    }

    /* AI Chat Sidebar */
    .chat-sidebar {
      width: 400px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-left: 2px solid rgba(102, 126, 234, 0.3);
      box-shadow: -5px 0 30px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }

    .chat-sidebar.collapsed {
      transform: translateX(100%);
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
    }

    .chat-header {
      padding: 20px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    }

    .chat-title {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
    }

    .collapse-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 85%;
      line-height: 1.5;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .message.user {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      align-self: flex-end;
      margin-left: auto;
    }

    .message.assistant {
      background: #ffffff;
      color: #2c3e50;
      align-self: flex-start;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .chat-input-container {
      padding: 20px;
      border-top: 2px solid rgba(102, 126, 234, 0.2);
      background: rgba(255, 255, 255, 0.5);
    }

    .chat-input-box {
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 12px;
      background: #ffffff;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      color: #2c3e50;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .send-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    /* Floating Chat Toggle */
    .chat-toggle {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: #667eea;
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 200;
      display: none;
    }

    .chat-toggle:hover {
      background: #5568d3;
    }

    .chat-sidebar.collapsed ~ .chat-toggle {
      display: block;
    }

    /* Month View */
    .month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
      background: rgba(102, 126, 234, 0.1);
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 10px;
      overflow: hidden;
    }

    .month-day {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      padding: 10px;
      min-height: 120px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      transition: all 0.2s;
    }

    .month-day:hover {
      background: rgba(102, 126, 234, 0.1);
      transform: scale(1.02);
    }

    .month-day.weekend {
      background: rgba(118, 75, 162, 0.05);
    }

    .month-day.other-month {
      background: rgba(255, 255, 255, 0.3);
      color: #999;
    }

    .month-day-number {
      font-size: 14px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .month-day-number.today {
      display: inline-block;
      width: 28px;
      height: 28px;
      line-height: 28px;
      text-align: center;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #ffffff;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .day-header {
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      text-align: center;
      font-weight: 600;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      color: #2c3e50;
    }

    .month-event {
      padding: 2px 6px;
      margin-bottom: 2px;
      border-radius: 3px;
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background: rgba(102, 126, 234, 0.9);
      cursor: pointer;
    }

    .loading {
      text-align: center;
      padding: 60px;
      font-size: 18px;
      color: #999;
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="top-bar">
    <div class="top-bar-left">
      <select class="calendar-selector" id="calendarSelector" onchange="changeCalendar()">
        <option value="">Naƒç√≠tavam kalend√°re...</option>
      </select>
      
      <div class="view-mode-btns">
        <button class="view-btn active" onclick="setViewMode('month')">Mesiac</button>
        <button class="view-btn" onclick="setViewMode('week')">T√Ω≈æde≈à</button>
      </div>
    </div>

    <div class="nav-controls">
      <button class="nav-btn" onclick="previousPeriod()">‚Äπ</button>
      <div class="current-period" id="currentPeriod"></div>
      <button class="nav-btn" onclick="nextPeriod()">‚Ä∫</button>
      <button class="nav-btn" onclick="goToToday()">Dnes</button>
    </div>

    <div class="top-bar-right">
      <button class="icon-btn" onclick="toggleChat()" title="AI Asistent">üí¨</button>
      <button class="icon-btn" onclick="refreshEvents()" title="Obnovi≈•">üîÑ</button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Calendar View -->
    <div class="calendar-view" id="calendarView">
      <div class="loading">Naƒç√≠tavam kalend√°r...</div>
    </div>

    <!-- AI Chat Sidebar -->
    <div class="chat-sidebar" id="chatSidebar">
      <div class="chat-header">
        <div class="chat-title">ü§ñ AI Asistent</div>
        <button class="collapse-btn" onclick="toggleChat()">‚Ä∫</button>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="message assistant">
          Ahoj! Som tvoj AI asistent. M√¥≈æem ti pom√¥c≈• s kalend√°rom:
          <br><br>
          ‚Ä¢ Vytvori≈• udalos≈•<br>
          ‚Ä¢ Zobrazi≈• udalosti<br>
          ‚Ä¢ Upravi≈• term√≠ny<br>
          ‚Ä¢ Pl√°nova≈• z√°kazky
        </div>
      </div>

      <div class="chat-input-container">
        <div class="chat-input-box">
          <input type="text" class="chat-input" id="chatInput" 
                 placeholder="Nap√≠≈° spr√°vu..." 
                 onkeypress="if(event.key==='Enter') sendMessage()">
          <button class="send-btn" onclick="sendMessage()">Odosla≈•</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Chat Toggle -->
  <button class="chat-toggle" onclick="toggleChat()">üí¨</button>

  <script>
    const scriptUrl = localStorage.getItem('scriptUrl');
    if (!scriptUrl) {
      window.location.href = '/connect.html';
    }

    let calendars = [];
    let currentCalendarId = null;
    let events = [];
    let currentDate = new Date();
    let viewMode = 'month';
    let sessionId = Math.random().toString(36).substring(7);

    // Initialize
    async function init() {
      await loadCalendars();
      await loadEvents();
      render();
    }

    // Toggle chat
    function toggleChat() {
      const sidebar = document.getElementById('chatSidebar');
      sidebar.classList.toggle('collapsed');
    }

    // Load calendars
    async function loadCalendars() {
      try {
        const url = new URL(scriptUrl);
        url.searchParams.append('action', 'getCalendars');
        
        const response = await fetch(url.toString());
        const data = await response.json();
        
        if (data.ok && data.calendars) {
          calendars = data.calendars;
          
          const selector = document.getElementById('calendarSelector');
          selector.innerHTML = `<option value="">üìÖ V≈°etky kalend√°re (${calendars.length})</option>` +
            calendars.map(cal => 
              `<option value="${cal.id}">üìå ${cal.name}</option>`
            ).join('');
          
          if (calendars.length > 0) {
            currentCalendarId = calendars[0].id;
            selector.value = currentCalendarId;
          }
          
          // Log for debugging
          console.log(`‚úÖ Naƒç√≠tan√© ${calendars.length} kalend√°rov:`, calendars.map(c => c.name));
        }
      } catch (error) {
        console.error('Error loading calendars:', error);
        const selector = document.getElementById('calendarSelector');
        selector.innerHTML = '<option value="">‚ùå Chyba naƒç√≠tania</option>';
      }
    }

    // Load events
    async function loadEvents() {
      if (!currentCalendarId) return;
      
      try {
        const url = new URL(scriptUrl);
        url.searchParams.append('action', 'getEvents');
        url.searchParams.append('calendarId', currentCalendarId);
        url.searchParams.append('maxResults', '200');
        url.searchParams.append('daysAhead', '60');
        
        const response = await fetch(url.toString());
        const data = await response.json();
        
        if (data.ok && data.events) {
          events = data.events;
        }
      } catch (error) {
        console.error('Error loading events:', error);
      }
    }

    // Change calendar
    async function changeCalendar() {
      const selector = document.getElementById('calendarSelector');
      currentCalendarId = selector.value;
      
      const selectedCalendar = calendars.find(c => c.id === currentCalendarId);
      const calendarName = selectedCalendar ? selectedCalendar.name : 'V≈°etky kalend√°re';
      
      console.log(`üìÖ Prepnut√© na: ${calendarName}`);
      
      await loadEvents();
      render();
      
      // Update chat with info
      addChatMessage('assistant', `‚úÖ Zobrazujem kalend√°r: **${calendarName}**`);
    }

    // Refresh
    async function refreshEvents() {
      await loadEvents();
      render();
    }

    // Set view mode
    function setViewMode(mode) {
      viewMode = mode;
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      render();
    }

    // Navigation
    function goToToday() {
      currentDate = new Date();
      render();
    }

    function previousPeriod() {
      if (viewMode === 'week') {
        currentDate.setDate(currentDate.getDate() - 7);
      } else {
        currentDate.setMonth(currentDate.getMonth() - 1);
      }
      render();
    }

    function nextPeriod() {
      if (viewMode === 'week') {
        currentDate.setDate(currentDate.getDate() + 7);
      } else {
        currentDate.setMonth(currentDate.getMonth() + 1);
      }
      render();
    }

    // Render
    function render() {
      renderMonthView();
    }

    // Render month view
    function renderMonthView() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      document.getElementById('currentPeriod').textContent = 
        currentDate.toLocaleDateString('sk-SK', {month: 'long', year: 'numeric'});
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      let startDay = firstDay.getDay();
      if (startDay === 0) startDay = 7;
      startDay -= 1;
      
      let html = '<div class="month-grid">';
      
      // Day headers
      ['Pon', 'Uto', 'Str', '≈†tv', 'Pia', 'Sob', 'Ned'].forEach(day => {
        html += `<div class="day-header">${day}</div>`;
      });
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Previous month days
      const prevLastDay = new Date(year, month, 0).getDate();
      for (let i = startDay - 1; i >= 0; i--) {
        const day = prevLastDay - i;
        html += `<div class="month-day other-month"><div class="month-day-number">${day}</div></div>`;
      }
      
      // Current month days
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, month, day);
        date.setHours(0, 0, 0, 0);
        
        const isToday = date.getTime() === today.getTime();
        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
        
        html += `<div class="month-day ${isWeekend ? 'weekend' : ''}" onclick="askAIAboutDay('${date.toISOString()}')">`;
        html += `<div class="month-day-number ${isToday ? 'today' : ''}">${day}</div>`;
        
        // Add events for this day
        const dayEvents = events.filter(event => {
          const eventDate = new Date(event.start.dateTime || event.start.date);
          eventDate.setHours(0, 0, 0, 0);
          return eventDate.getTime() === date.getTime();
        });
        
        dayEvents.slice(0, 4).forEach(event => {
          html += `<div class="month-event">${event.summary || event.title}</div>`;
        });
        
        if (dayEvents.length > 4) {
          html += `<div style="font-size: 10px; color: #999; margin-top: 2px;">+${dayEvents.length - 4}</div>`;
        }
        
        html += '</div>';
      }
      
      html += '</div>';
      
      document.getElementById('calendarView').innerHTML = html;
    }

    // Ask AI about day
    function askAIAboutDay(dateStr) {
      const date = new Date(dateStr);
      const dayEvents = events.filter(event => {
        const eventDate = new Date(event.start.dateTime || event.start.date);
        eventDate.setHours(0, 0, 0, 0);
        date.setHours(0, 0, 0, 0);
        return eventDate.getTime() === date.getTime();
      });
      
      if (dayEvents.length > 0) {
        let message = `Udalosti na ${date.toLocaleDateString('sk-SK')}:\n\n`;
        dayEvents.forEach(e => {
          const time = new Date(e.start.dateTime || e.start.date).toLocaleTimeString('sk-SK', {hour: '2-digit', minute: '2-digit'});
          message += `‚Ä¢ ${time} - ${e.summary}\n`;
        });
        addChatMessage('assistant', message);
      } else {
        addChatMessage('assistant', `${date.toLocaleDateString('sk-SK')} - ≈æiadne udalosti`);
      }
      
      if (document.getElementById('chatSidebar').classList.contains('collapsed')) {
        toggleChat();
      }
    }

    // Send message
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      addChatMessage('user', message);
      input.value = '';
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, sessionId })
        });
        
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Backend vracia buƒè 'response' alebo 'error'
        const aiReply = data.response || data.error || 'Nepodarilo sa z√≠ska≈• odpoveƒè';
        
        addChatMessage('assistant', aiReply);
        
        // Refresh calendar if event was created
        if (aiReply.includes('vytvoren√°') || aiReply.includes('pridan√°') || aiReply.includes('kalend√°r')) {
          setTimeout(() => refreshEvents(), 1000);
        }
      } catch (error) {
        console.error('Chat error:', error);
        addChatMessage('assistant', '‚ùå Chyba: ' + error.message);
      }
    }

    // Add chat message
    function addChatMessage(role, text) {
      const messagesDiv = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${role}`;
      
      // Form√°tuj text - podporuj markdown-like formatting
      let formattedText = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // **bold**
        .replace(/\n/g, '<br>'); // nov√© riadky
      
      msgDiv.innerHTML = formattedText;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Initialize
    init();
  </script>
</body>
</html>


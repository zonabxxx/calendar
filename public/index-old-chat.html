<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìÖ ChatGPT Kalend√°r Asistent</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      max-width: 1200px;
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 20px;
      height: 90vh;
    }

    .chat-panel, .calendar-panel {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      display: flex;
      gap: 10px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .message.user .avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .message.assistant .avatar {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .message .content {
      background: #f0f0f0;
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 70%;
      word-wrap: break-word;
    }

    .message.user .content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .message.assistant .content {
      background: #f0f0f0;
      color: #333;
    }

    .function-call {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 8px 12px;
      margin-top: 5px;
      border-radius: 4px;
      font-size: 13px;
      color: #1976d2;
    }

    .input-area {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
    }

    input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      border-color: #667eea;
    }

    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .reset-btn {
      padding: 8px 16px;
      font-size: 13px;
      background: #ff6b6b;
      margin-left: auto;
    }

    .calendar-panel .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .events-list {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .event-card {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .event-card:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .event-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      font-size: 15px;
    }

    .event-time {
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
    }

    .event-location {
      font-size: 13px;
      color: #999;
      margin-bottom: 5px;
    }

    .event-description {
      font-size: 12px;
      color: #777;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e0e0e0;
      line-height: 1.4;
      max-height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-attendees {
      font-size: 12px;
      color: #666;
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .attendee-badge {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      display: inline-block;
    }

    /* Calendar View */
    .calendar-view {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
    }

    .calendar-header h3 {
      margin: 0;
      color: #333;
      font-size: 18px;
    }

    .nav-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }

    .nav-btn:hover {
      background: #764ba2;
      transform: scale(1.1);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .calendar-day-header {
      text-align: center;
      font-weight: bold;
      color: #667eea;
      padding: 8px;
      font-size: 12px;
    }

    .calendar-day {
      aspect-ratio: 1;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 5px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      background: white;
      display: flex;
      flex-direction: column;
    }

    .calendar-day:hover {
      background: #f5f5f5;
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .calendar-day.other-month {
      opacity: 0.3;
    }

    .calendar-day.today {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: bold;
    }

    .calendar-day.has-events {
      border-color: #667eea;
      border-width: 2px;
    }

    .day-number {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .day-events {
      font-size: 9px;
      color: #999;
      overflow: hidden;
    }

    .calendar-day.today .day-events {
      color: rgba(255,255,255,0.8);
    }

    .event-dot {
      width: 4px;
      height: 4px;
      background: #667eea;
      border-radius: 50%;
      display: inline-block;
      margin: 1px;
    }

    .calendar-day.today .event-dot {
      background: white;
    }

    /* Week View */
    .week-view {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .week-grid {
      display: flex;
      gap: 8px;
    }

    .week-day {
      flex: 1;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 10px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .week-day-header {
      text-align: center;
      font-weight: bold;
      color: #667eea;
      padding: 8px;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 8px;
    }

    .week-day.today .week-day-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      border-bottom: none;
    }

    .week-event {
      background: white;
      border-left: 3px solid #667eea;
      padding: 6px 8px;
      margin-bottom: 6px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .week-event:hover {
      transform: translateX(3px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .week-event-time {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 2px;
    }

    .week-event-title {
      color: #333;
      margin-bottom: 2px;
    }

    .week-event-location {
      color: #999;
      font-size: 10px;
    }

    /* Event Colors by Type */
    .event-work { border-left-color: #2196f3; }
    .event-work .week-event-time { color: #2196f3; }
    .event-work .event-dot { background: #2196f3; }

    .event-personal { border-left-color: #4caf50; }
    .event-personal .week-event-time { color: #4caf50; }
    .event-personal .event-dot { background: #4caf50; }

    .event-meeting { border-left-color: #ff9800; }
    .event-meeting .week-event-time { color: #ff9800; }
    .event-meeting .event-dot { background: #ff9800; }

    .event-birthday { border-left-color: #e91e63; }
    .event-birthday .week-event-time { color: #e91e63; }
    .event-birthday .event-dot { background: #e91e63; }

    .event-test { border-left-color: #9e9e9e; }
    .event-test .week-event-time { color: #9e9e9e; }
    .event-test .event-dot { background: #9e9e9e; }

    /* Legend */
    .legend {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
      font-size: 11px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #999;
    }

    .typing-indicator {
      display: flex;
      gap: 5px;
      padding: 12px 16px;
      background: #f0f0f0;
      border-radius: 18px;
      width: fit-content;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #999;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .quick-actions {
      padding: 15px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .quick-btn {
      padding: 8px 12px;
      font-size: 13px;
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-btn:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    @media (max-width: 968px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
        height: 95vh;
      }

      .calendar-panel {
        max-height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Chat Panel -->
    <div class="chat-panel">
      <div class="header">
        ü§ñ ChatGPT Kalend√°r Asistent
        <button class="reset-btn" onclick="resetChat()">üîÑ Reset</button>
      </div>
      
      <div class="messages" id="messages">
        <div class="message assistant">
          <div class="avatar">ü§ñ</div>
          <div class="content">
            Ahoj! Som tvoj kalend√°rny asistent. M√¥≈æem ti uk√°za≈• udalosti, prida≈• nov√© stretnutia, alebo odpoveda≈• na ot√°zky o tvojom kalend√°ri. ƒåo potrebuje≈°?
          </div>
        </div>
      </div>

      <div class="quick-actions">
        <button class="quick-btn" onclick="quickMessage('Uk√°≈æ mi udalosti na tento t√Ω≈æde≈à')">üìÖ Tento t√Ω≈æde≈à</button>
        <button class="quick-btn" onclick="quickMessage('ƒåo m√°m zajtra?')">üìÜ Zajtra</button>
        <button class="quick-btn" onclick="quickMessage('Pridaj stretnutie')">‚ûï Prida≈•</button>
        <button class="quick-btn" onclick="showOrderForm()">üìã Nov√° z√°kazka</button>
      </div>

      <div class="input-area">
        <input 
          type="text" 
          id="userInput" 
          placeholder="Nap√≠≈° svoju spr√°vu..."
          onkeypress="handleKeyPress(event)"
        >
        <button onclick="sendMessage()" id="sendBtn">Odosla≈•</button>
      </div>
    </div>

    <!-- Calendar Panel -->
    <div class="calendar-panel">
      <div class="header">
        <div style="display: flex; flex-direction: column; gap: 8px; flex: 1;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>üìÖ Kalend√°r</span>
            <div style="display: flex; gap: 5px;">
              <button class="quick-btn" onclick="toggleView('list')" id="viewToggleList" style="background: white; color: #667eea;">üìã</button>
              <button class="quick-btn" onclick="toggleView('week')" id="viewToggleWeek" style="background: white; color: #667eea;">üìÖ</button>
              <button class="quick-btn" onclick="toggleView('month')" id="viewToggleMonth" style="background: white; color: #667eea;">üóìÔ∏è</button>
              <button class="quick-btn" onclick="loadEvents()" style="background: white; color: #667eea;">üîÑ</button>
            </div>
          </div>
          <select id="calendarSelect" onchange="changeCalendar()" style="padding: 8px; border-radius: 6px; border: 2px solid #667eea; font-size: 14px; font-weight: 600; cursor: pointer;">
            <option value="all">üåê V≈°etky kalend√°re</option>
          </select>
        </div>
      </div>
      
      <!-- Monthly view -->
      <div class="calendar-view" id="monthView" style="display: none;">
        <div class="calendar-header">
          <button class="nav-btn" onclick="changeMonth(-1)">‚óÄ</button>
          <h3 id="currentMonth">Okt√≥ber 2025</h3>
          <button class="nav-btn" onclick="changeMonth(1)">‚ñ∂</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>

      <!-- Weekly view -->
      <div class="week-view" id="weekView" style="display: none;">
        <div class="calendar-header">
          <button class="nav-btn" onclick="changeWeek(-1)">‚óÄ</button>
          <h3 id="currentWeek">T√Ω≈æde≈à 42, 2025</h3>
          <button class="nav-btn" onclick="changeWeek(1)">‚ñ∂</button>
        </div>
        <div class="week-grid" id="weekGrid"></div>
      </div>
      
      <!-- Zoznam udalost√≠ -->
      <div class="events-list" id="eventsList">
        <div class="loading">Naƒç√≠tavam udalosti...</div>
      </div>
    </div>
  </div>

  <script>
    // Check if connected
    const scriptUrl = localStorage.getItem('scriptUrl');
    if (!scriptUrl) {
      window.location.href = '/connect.html';
    }

    const sessionId = Math.random().toString(36).substring(7);
    const messagesDiv = document.getElementById('messages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const eventsListDiv = document.getElementById('eventsList');
    const monthView = document.getElementById('monthView');
    const weekView = document.getElementById('weekView');
    const calendarGrid = document.getElementById('calendarGrid');
    const weekGrid = document.getElementById('weekGrid');

    let currentDate = new Date();
    let currentWeekStart = getWeekStart(new Date());
    let allEvents = [];
    let allCalendars = [];
    let selectedCalendarId = 'all';
    let currentView = 'list'; // 'list', 'week', 'month'

    // User info
    const userEmail = localStorage.getItem('userEmail') || 'Prihl√°sen√Ω';

    // Add user info to header
    document.querySelector('.header').innerHTML = `
      üìÖ Kalend√°r
      <div style="display: flex; gap: 10px; align-items: center;">
        <span style="font-size: 13px; color: rgba(255,255,255,0.9);">${userEmail}</span>
        <button class="quick-btn" onclick="logout()" style="background: rgba(255,255,255,0.2); color: white;">üö™</button>
      </div>
    `;

    function logout() {
      if (confirm('Odpoji≈• sa od kalend√°ra?')) {
        localStorage.removeItem('scriptUrl');
        localStorage.removeItem('userEmail');
        window.location.href = '/connect.html';
      }
    }

    // Naƒç√≠taj kalend√°re a udalosti pri naƒç√≠tan√≠ str√°nky
    loadCalendars();
    loadEvents();

    // Naƒç√≠taj zoznam kalend√°rov
    async function loadCalendars() {
      try {
        const url = new URL(scriptUrl);
        url.searchParams.append('action', 'getCalendars');
        
        const response = await fetch(url.toString());
        const data = await response.json();
        
        if (data.ok && data.calendars) {
          allCalendars = data.calendars;
          
          // Napl≈à select
          const select = document.getElementById('calendarSelect');
          select.innerHTML = '<option value="all">üåê V≈°etky kalend√°re (' + data.calendars.length + ')</option>';
          
          data.calendars.forEach(cal => {
            const option = document.createElement('option');
            option.value = cal.id;
            option.textContent = cal.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading calendars:', error);
      }
    }

    // Zmena kalend√°ra
    function changeCalendar() {
      const select = document.getElementById('calendarSelect');
      selectedCalendarId = select.value;
      loadEvents();
    }

    // Helper: Get Monday of current week
    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    // Detect event type by keywords
    function getEventType(event) {
      const text = `${event.summary || event.title || ''} ${event.description || ''}`.toLowerCase();
      
      if (text.includes('narodeniny') || text.includes('birthday')) return 'birthday';
      if (text.includes('stretnutie') || text.includes('meeting') || text.includes('meet')) return 'meeting';
      if (text.includes('test')) return 'test';
      if (text.includes('pr√°ca') || text.includes('work') || text.includes('office')) return 'work';
      
      return 'personal';
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    function quickMessage(message) {
      userInput.value = message;
      sendMessage();
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      // Zobraz pou≈æ√≠vateƒæovu spr√°vu
      addMessage('user', message);
      userInput.value = '';
      sendBtn.disabled = true;

      // Zobraz typing indicator
      const typingId = addTypingIndicator();

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, sessionId })
        });

        const data = await response.json();
        
        // Odstr√°≈à typing indicator
        removeTypingIndicator(typingId);

        if (data.error) {
          addMessage('assistant', '‚ùå ' + data.error);
        } else {
          // Zobraz volania funkci√≠
          if (data.functionCalls && data.functionCalls.length > 0) {
            data.functionCalls.forEach(call => {
              addFunctionCall(call.name, call.args);
            });
          }

          // Zobraz odpoveƒè
          addMessage('assistant', data.response);

          // Refresh kalend√°r ak bola pridan√° udalos≈• (bez loading)
          if (data.functionCalls?.some(c => c.name === 'add_event')) {
            setTimeout(() => loadEvents(false), 1000);
          }
        }
      } catch (error) {
        removeTypingIndicator(typingId);
        addMessage('assistant', '‚ùå Chyba: ' + error.message);
      } finally {
        sendBtn.disabled = false;
        userInput.focus();
      }
    }

    function addMessage(role, content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;
      messageDiv.innerHTML = `
        <div class="avatar">${role === 'user' ? 'üë§' : 'ü§ñ'}</div>
        <div class="content">${content}</div>
      `;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addFunctionCall(name, args) {
      const lastMessage = messagesDiv.lastElementChild;
      if (lastMessage && lastMessage.classList.contains('assistant')) {
        const content = lastMessage.querySelector('.content');
        const callDiv = document.createElement('div');
        callDiv.className = 'function-call';
        
        const icon = name === 'list_events' ? 'üìã' : '‚ûï';
        const text = name === 'list_events' ? 'Naƒç√≠tavam udalosti...' : 'Prid√°vam udalos≈•...';
        
        callDiv.textContent = `${icon} ${text}`;
        content.appendChild(callDiv);
      }
    }

    function addTypingIndicator() {
      const id = 'typing-' + Date.now();
      const messageDiv = document.createElement('div');
      messageDiv.id = id;
      messageDiv.className = 'message assistant';
      messageDiv.innerHTML = `
        <div class="avatar">ü§ñ</div>
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      return id;
    }

    function removeTypingIndicator(id) {
      const element = document.getElementById(id);
      if (element) element.remove();
    }

    let isLoadingEvents = false;

    async function loadEvents(showLoading = true) {
      // Zabr√°≈à s√∫ƒçasn√©mu naƒç√≠tavaniu
      if (isLoadingEvents) return;
      isLoadingEvents = true;

      if (showLoading) {
        eventsListDiv.innerHTML = '<div class="loading">Naƒç√≠tavam udalosti...</div>';
      }
      
      try {
        const scriptUrl = localStorage.getItem('scriptUrl');
        if (!scriptUrl) {
          console.error('Script URL not found');
          return;
        }
        
        const url = new URL(scriptUrl);
        url.searchParams.append('action', 'getEvents');
        
        // Ak je vybran√Ω konkr√©tny kalend√°r, naƒç√≠taj len z neho
        if (selectedCalendarId === 'all') {
          url.searchParams.append('allCalendars', 'true');
        } else {
          url.searchParams.append('calendarId', selectedCalendarId);
        }
        
        url.searchParams.append('maxResults', '100');
        url.searchParams.append('daysAhead', '60');
        
        const response = await fetch(url.toString());
        const data = await response.json();
        
        console.log('Events data:', data);

        if (data.events && data.events.length > 0) {
          // Ulo≈æ udalosti pre kalend√°r
          allEvents = data.events;
          
          // Vytvor nov√Ω obsah
          const fragment = document.createDocumentFragment();
          
          data.events.forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event-card';
            
            // Parse start time - handle both formats
            let startDate;
            if (event.start && event.start.dateTime) {
              startDate = new Date(event.start.dateTime);
            } else if (event.start) {
              startDate = new Date(event.start);
            } else {
              console.error('Invalid event start:', event);
              return;
            }
            
            // Check if date is valid
            if (isNaN(startDate.getTime())) {
              console.error('Invalid date:', event);
              return;
            }
            
            const timeStr = startDate.toLocaleString('sk-SK', { 
              month: 'short', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            const title = event.title || event.summary || 'Bez n√°zvu';
            const location = event.location || '';
            const description = event.description || '';
            const attendees = event.attendees || [];
            const eventType = getEventType(event);
            
            // Add color to card
            eventDiv.classList.add(`event-${eventType}`);
            
            // Form√°tuj √∫ƒçastn√≠kov
            let attendeesHTML = '';
            if (attendees && attendees.length > 0) {
              const names = attendees.map(a => {
                const name = a.name || a.email || a;
                // Extrahuj iba meno pred @ z emailu
                return name.includes('@') ? name.split('@')[0] : name;
              });
              attendeesHTML = `
                <div class="event-attendees">
                  üë• ${names.map(name => `<span class="attendee-badge">${name}</span>`).join(' ')}
                </div>
              `;
            }
            
            // Skr√°≈• popis ak je pr√≠li≈° dlh√Ω
            let descHTML = '';
            if (description && description !== '{}') {
              const shortDesc = description.length > 100 
                ? description.substring(0, 100) + '...' 
                : description;
              descHTML = `<div class="event-description">${shortDesc}</div>`;
            }

            // Type emoji
            const typeEmoji = {
              work: 'üíº',
              meeting: 'ü§ù',
              personal: 'üéØ',
              birthday: 'üéÇ',
              test: 'üß™'
            }[eventType] || 'üìå';

            eventDiv.innerHTML = `
              <div class="event-title">${typeEmoji} ${title}</div>
              <div class="event-time">üìÖ ${timeStr}</div>
              ${location ? `<div class="event-location">üìç ${location}</div>` : ''}
              ${attendeesHTML}
              ${descHTML}
            `;
            fragment.appendChild(eventDiv);
          });
          
          // Nahraƒè obsah jedn√Ωm oper√°ciou (menej blikania)
          eventsListDiv.innerHTML = '';
          eventsListDiv.appendChild(fragment);
        } else {
          eventsListDiv.innerHTML = '<div class="loading">≈Ωiadne nadch√°dzaj√∫ce udalosti</div>';
        }
      } catch (error) {
        console.error('Load events error:', error);
        if (showLoading) {
          eventsListDiv.innerHTML = '<div class="loading">‚ùå Chyba: ' + error.message + '</div>';
        }
      } finally {
        isLoadingEvents = false;
      }
    }

    async function resetChat() {
      if (confirm('Naozaj chce≈° resetova≈• konverz√°ciu?')) {
        try {
          await fetch('/api/reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId })
          });
          
          messagesDiv.innerHTML = `
            <div class="message assistant">
              <div class="avatar">ü§ñ</div>
              <div class="content">
                Konverz√°cia bola resetovan√°. M√¥≈æeme zaƒça≈• odznova! üîÑ
              </div>
            </div>
          `;
        } catch (error) {
          alert('Chyba pri resetovan√≠: ' + error.message);
        }
      }
    }

    function toggleView(view) {
      currentView = view;
      
      // Hide all views
      eventsListDiv.style.display = 'none';
      monthView.style.display = 'none';
      weekView.style.display = 'none';
      
      // Reset button styles
      ['List', 'Week', 'Month'].forEach(v => {
        const btn = document.getElementById(`viewToggle${v}`);
        if (btn) btn.style.background = 'white';
      });
      
      // Show selected view
      if (view === 'list') {
        eventsListDiv.style.display = 'block';
        document.getElementById('viewToggleList').style.background = '#667eea';
      } else if (view === 'week') {
        weekView.style.display = 'block';
        document.getElementById('viewToggleWeek').style.background = '#667eea';
        renderWeek();
      } else if (view === 'month') {
        monthView.style.display = 'block';
        document.getElementById('viewToggleMonth').style.background = '#667eea';
        renderCalendar();
      }
    }

    function changeMonth(delta) {
      currentDate.setMonth(currentDate.getMonth() + delta);
      renderCalendar();
    }

    function changeWeek(delta) {
      currentWeekStart.setDate(currentWeekStart.getDate() + (delta * 7));
      renderWeek();
    }

    function renderWeek() {
      const weekStart = new Date(currentWeekStart);
      const weekNum = getWeekNumber(weekStart);
      const year = weekStart.getFullYear();
      
      document.getElementById('currentWeek').textContent = `T√Ω≈æde≈à ${weekNum}, ${year}`;
      
      weekGrid.innerHTML = '';
      
      const today = new Date();
      const dayNames = ['Pondelok', 'Utorok', 'Streda', '≈†tvrtok', 'Piatok', 'Sobota', 'Nedeƒæa'];
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);
        
        const dayCol = document.createElement('div');
        dayCol.className = 'week-day';
        if (date.toDateString() === today.toDateString()) {
          dayCol.classList.add('today');
        }
        
        const header = document.createElement('div');
        header.className = 'week-day-header';
        header.innerHTML = `
          <div style="font-size: 11px;">${dayNames[i]}</div>
          <div style="font-size: 16px; font-weight: bold;">${date.getDate()}</div>
        `;
        dayCol.appendChild(header);
        
        // Find events for this day
        const dayEvents = allEvents.filter(event => {
          const eventDate = new Date(event.start.dateTime || event.start);
          return eventDate.toDateString() === date.toDateString();
        }).sort((a, b) => {
          const timeA = new Date(a.start.dateTime || a.start);
          const timeB = new Date(b.start.dateTime || b.start);
          return timeA - timeB;
        });
        
        dayEvents.forEach(event => {
          const eventDiv = document.createElement('div');
          const eventType = getEventType(event);
          eventDiv.className = `week-event event-${eventType}`;
          
          const time = new Date(event.start.dateTime || event.start).toLocaleTimeString('sk-SK', {
            hour: '2-digit',
            minute: '2-digit'
          });
          
          eventDiv.innerHTML = `
            <div class="week-event-time">${time}</div>
            <div class="week-event-title">${event.title || event.summary}</div>
            ${event.location ? `<div class="week-event-location">üìç ${event.location}</div>` : ''}
          `;
          
          eventDiv.onclick = () => showEventDetails(event);
          dayCol.appendChild(eventDiv);
        });
        
        weekGrid.appendChild(dayCol);
      }
    }

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    function showEventDetails(event) {
      const start = new Date(event.start.dateTime || event.start);
      const end = new Date(event.end.dateTime || event.end);
      
      let message = `üìÖ ${event.title || event.summary}\n\n`;
      message += `üïê ${start.toLocaleString('sk-SK')}\n`;
      message += `   ‚Üí ${end.toLocaleTimeString('sk-SK', {hour: '2-digit', minute: '2-digit'})}\n\n`;
      
      if (event.location) message += `üìç ${event.location}\n\n`;
      if (event.description && event.description !== '{}') {
        message += `üìù ${event.description}\n\n`;
      }
      
      if (event.attendees && event.attendees.length > 0) {
        message += `üë• √öƒçastn√≠ci:\n`;
        event.attendees.forEach(a => {
          message += `   ‚Ä¢ ${a.name || a.email}\n`;
        });
      }
      
      alert(message);
    }

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // Update header
      const monthNames = ['Janu√°r', 'Febru√°r', 'Marec', 'Apr√≠l', 'M√°j', 'J√∫n', 
                          'J√∫l', 'August', 'September', 'Okt√≥ber', 'November', 'December'];
      document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
      
      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday
      
      // Adjust to Monday start
      const adjustedStart = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
      
      // Clear grid
      calendarGrid.innerHTML = '';
      
      // Add day headers
      const dayHeaders = ['Po', 'Ut', 'St', '≈†t', 'Pi', 'So', 'Ne'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        calendarGrid.appendChild(header);
      });
      
      // Add previous month days
      const prevMonthDays = new Date(year, month, 0).getDate();
      for (let i = adjustedStart - 1; i >= 0; i--) {
        const day = prevMonthDays - i;
        const dayDiv = createDayElement(day, true, new Date(year, month - 1, day));
        calendarGrid.appendChild(dayDiv);
      }
      
      // Add current month days
      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const isToday = date.toDateString() === today.toDateString();
        const dayDiv = createDayElement(day, false, date, isToday);
        calendarGrid.appendChild(dayDiv);
      }
      
      // Add next month days
      const remainingDays = 42 - (adjustedStart + daysInMonth); // 6 rows * 7 days
      for (let day = 1; day <= remainingDays; day++) {
        const dayDiv = createDayElement(day, true, new Date(year, month + 1, day));
        calendarGrid.appendChild(dayDiv);
      }
    }

    function createDayElement(day, isOtherMonth, date, isToday = false) {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'calendar-day';
      if (isOtherMonth) dayDiv.classList.add('other-month');
      if (isToday) dayDiv.classList.add('today');
      
      // Find events for this day
      const dayEvents = allEvents.filter(event => {
        const eventDate = new Date(event.start.dateTime || event.start);
        return eventDate.toDateString() === date.toDateString();
      });
      
      if (dayEvents.length > 0) {
        dayDiv.classList.add('has-events');
      }
      
      const dayNumber = document.createElement('div');
      dayNumber.className = 'day-number';
      dayNumber.textContent = day;
      
      const eventsDiv = document.createElement('div');
      eventsDiv.className = 'day-events';
      
      if (dayEvents.length > 0) {
        // Show colored dots for events by type
        const eventsByType = {};
        dayEvents.forEach(event => {
          const type = getEventType(event);
          eventsByType[type] = (eventsByType[type] || 0) + 1;
        });
        
        Object.keys(eventsByType).slice(0, 3).forEach(type => {
          const dot = document.createElement('span');
          dot.className = `event-dot event-${type}`;
          eventsDiv.appendChild(dot);
        });
        
        if (dayEvents.length > 3) {
          eventsDiv.appendChild(document.createTextNode(` +${dayEvents.length - 3}`));
        }
      }
      
      dayDiv.appendChild(dayNumber);
      dayDiv.appendChild(eventsDiv);
      
      // Click to show events for this day
      dayDiv.onclick = () => {
        if (dayEvents.length > 0) {
          showDayEvents(date, dayEvents);
        }
      };
      
      return dayDiv;
    }

    function showDayEvents(date, events) {
      const dateStr = date.toLocaleDateString('sk-SK', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      let message = `üìÖ ${dateStr}\n\n`;
      events.forEach((event, i) => {
        const time = new Date(event.start.dateTime || event.start).toLocaleTimeString('sk-SK', {
          hour: '2-digit',
          minute: '2-digit'
        });
        message += `${i + 1}. ${event.title || event.summary} (${time})\n`;
        if (event.location) message += `   üìç ${event.location}\n`;
      });
      
      alert(message);
    }

    // Show order form in chat
    async function showOrderForm() {
      // Najprv naƒç√≠taj kalend√°re
      addMessage('assistant', '‚è≥ Naƒç√≠tavam zoznam kalend√°rov...');
      
      try {
        const url = new URL(scriptUrl);
        url.searchParams.append('action', 'getCalendars');
        
        const response = await fetch(url.toString());
        const data = await response.json();
        
        if (!data.ok || !data.calendars) {
          addMessage('assistant', '‚ùå Chyba: Nepodarilo sa naƒç√≠ta≈• kalend√°re');
          return;
        }
        
        // Odstr√°≈à loading spr√°vu
        const lastMessage = messagesDiv.lastElementChild;
        if (lastMessage) lastMessage.remove();
        
        // Vytvor formul√°r s kalend√°rmi
        const calendars = data.calendars;
        
        let calendarOptions = '';
        calendars.forEach(cal => {
          calendarOptions += `<option value="${cal.id}">${cal.name}</option>`;
        });
        
        const formHTML = `
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
            <h3 style="margin-top: 0; color: #667eea;">üìã Nov√° Z√°kazka</h3>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: 600; margin-bottom: 5px;">N√°zov z√°kazky:</label>
              <input type="text" id="orderName" placeholder="napr. Let√°ky pre Tesco" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: 600; margin-bottom: 5px;">Term√≠n dokonƒçenia:</label>
              <input type="datetime-local" id="orderDeadline" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: 600; margin-bottom: 10px;">Procesy (√∫lohy):</label>
              <div id="tasksList" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Tasks will be added here -->
              </div>
              <button onclick="addTask()" style="margin-top: 10px; padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                ‚ûï Prida≈• proces
              </button>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="aiOptimizeSchedule()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; min-width: 150px;">
                ü§ñ AI Optimalizova≈•
              </button>
              <button onclick="submitOrderAdvanced()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; min-width: 150px;">
                ‚úÖ Vytvori≈• z√°kazku
              </button>
              <button onclick="closeOrderForm()" style="padding: 12px 20px; background: #f0f0f0; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                ‚ùå Zru≈°i≈•
              </button>
            </div>
          </div>
        `;
        
        addMessage('assistant', formHTML);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Ulo≈æ kalend√°re do glob√°lnej premennej
        window.availableCalendars = calendars;
        window.taskCounter = 0;
        
        // Pridaj prv√Ω proces automaticky (po malej pauze, aby DOM bol ready)
        setTimeout(() => {
          addTask();
        }, 100);
        
      } catch (error) {
        addMessage('assistant', `‚ùå Chyba: ${error.message}`);
      }
    }

    // Pridaj nov√Ω proces do formul√°ra
    function addTask() {
      console.log('addTask() called');
      const tasksList = document.getElementById('tasksList');
      console.log('tasksList element:', tasksList);
      
      if (!tasksList) {
        console.error('tasksList element not found!');
        return;
      }
      
      if (!window.availableCalendars) {
        console.error('window.availableCalendars not found!');
        return;
      }
      
      const taskId = window.taskCounter++;
      console.log('Creating task with ID:', taskId);
      
      let calendarOptions = '<option value="">-- Vyberte kalend√°r --</option>';
      window.availableCalendars.forEach(cal => {
        calendarOptions += `<option value="${cal.id}">${cal.name}</option>`;
      });
      
      const taskHTML = `
        <div class="task-row" id="task-${taskId}" style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
            <span style="font-weight: 600; color: #667eea;">Proces #${taskId + 1}</span>
            <button onclick="removeTask(${taskId})" style="background: #ff4757; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">
              ‚ùå Odstr√°ni≈•
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <div>
              <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px;">Kalend√°r (zamestnanec):</label>
              <select class="task-calendar" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                ${calendarOptions}
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px;">Trvanie (hodiny):</label>
              <input type="text" class="task-duration" value="4" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" placeholder="napr. 2.5 alebo 2,5" 
                     onblur="this.value = this.value.replace(',', '.')">
            </div>
          </div>
          
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px;">Popis √∫lohy:</label>
            <input type="text" class="task-description" placeholder="napr. N√°vrh grafiky, Tlaƒç materi√°lov..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
        </div>
      `;
      
      tasksList.insertAdjacentHTML('beforeend', taskHTML);
    }

    function removeTask(taskId) {
      const taskElement = document.getElementById(`task-${taskId}`);
      if (taskElement) {
        taskElement.remove();
      }
    }

    function closeOrderForm() {
      // Odstr√°≈à formul√°r
      const lastMessage = messagesDiv.lastElementChild;
      if (lastMessage) lastMessage.remove();
    }

    // AI Optimaliz√°cia rozvrhu
    async function aiOptimizeSchedule() {
      const orderName = document.getElementById('orderName').value.trim();
      const orderDeadline = document.getElementById('orderDeadline').value;
      
      if (!orderName) {
        alert('Zadajte n√°zov z√°kazky!');
        return;
      }
      
      // Z√≠skaj v≈°etky procesy
      const taskRows = document.querySelectorAll('.task-row');
      if (taskRows.length === 0) {
        alert('Pridajte aspo≈à jeden proces!');
        return;
      }
      
      const tasks = [];
      for (const row of taskRows) {
        const calendarId = row.querySelector('.task-calendar').value;
        const durationStr = row.querySelector('.task-duration').value.replace(',', '.'); // Slovensk√° ƒçiarka ‚Üí bodka
        const duration = parseFloat(durationStr);
        const description = row.querySelector('.task-description').value.trim();
        
        if (!calendarId) {
          alert('Vyberte kalend√°r pre v≈°etky procesy!');
          return;
        }
        
        if (isNaN(duration) || duration <= 0) {
          alert('Zadajte platn√© trvanie (napr. 1.5 alebo 1,5 hodiny)!');
          return;
        }
        
        if (!description) {
          alert('Zadajte popis pre v≈°etky procesy!');
          return;
        }
        
        const calendar = window.availableCalendars.find(c => c.id === calendarId);
        
        tasks.push({
          calendarId: calendarId,
          calendarName: calendar ? calendar.name : 'Nezn√°my',
          duration: duration,
          description: description
        });
      }
      
      // Zobraz loading
      addMessage('assistant', 'ü§ñ AI analyzuje kalend√°re a hƒæad√° optim√°lne ƒçasy...');
      
      try {
        // Zavolaj AI optimaliz√°tor
        const response = await fetch('/api/optimize-schedule', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tasks: tasks,
            deadline: orderDeadline || null,
            workingHours: { start: 8, end: 17 }
          })
        });
        
        const result = await response.json();
        
        // Odstr√°≈à loading spr√°vu
        const lastMessage = messagesDiv.lastElementChild;
        if (lastMessage) lastMessage.remove();
        
        if (result.success) {
          // Zobraz optimalizovan√Ω pl√°n
          let planHTML = `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
              <h3 style="margin-top: 0; color: #f5576c;">ü§ñ AI Optimalizovan√Ω Pl√°n</h3>
              
              ${result.aiReasoning ? `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                  <strong>üß† AI Anal√Ωza:</strong><br>
                  <div style="margin-top: 8px; font-size: 14px; line-height: 1.6;">
                    ${result.aiReasoning}
                  </div>
                </div>
              ` : ''}
              
              ${result.warnings && result.warnings.length > 0 ? `
                <div style="background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                  <strong>‚ö†Ô∏è Upozornenia:</strong><br>
                  <ul style="margin: 8px 0 0 20px; font-size: 13px;">
                    ${result.warnings.map(w => `<li>${w}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
              
              <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <strong style="color: #667eea;">üìä ≈†tatistiky:</strong><br>
                <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                  <div>‚è±Ô∏è Celkom: ${result.stats.totalHours}h</div>
                  <div>üìã Procesov: ${result.stats.totalProcesses}</div>
                  <div>üïê Od: ${new Date(result.stats.plannedStart).toLocaleString('sk-SK', {dateStyle: 'short', timeStyle: 'short'})}</div>
                  <div>üèÅ Do: ${new Date(result.stats.plannedEnd).toLocaleString('sk-SK', {dateStyle: 'short', timeStyle: 'short'})}</div>
                </div>
              </div>
              
              <div style="max-height: 400px; overflow-y: auto;">
          `;
          
          result.plan.forEach((task, idx) => {
            const start = task.suggestedStart ? new Date(task.suggestedStart) : null;
            const end = task.suggestedEnd ? new Date(task.suggestedEnd) : null;
            
            planHTML += `
              <div id="task-plan-${idx}" class="task-plan-item" draggable="true" 
                   style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${task.error ? '#ff4757' : (task.canRunParallel ? '#00d2ff' : '#4caf50')}; cursor: move;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                  <div style="font-weight: 600; color: #333;">
                    <span style="color: #999; margin-right: 5px;">‚ãÆ‚ãÆ</span>
                    ${idx + 1}. ${task.description}
                  </div>
                  <div style="display: flex; gap: 5px;">
                    ${task.canRunParallel ? `
                      <span style="background: #00d2ff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                        ‚ö° PARALELNE
                      </span>
                    ` : ''}
                    ${task.dependsOn !== null && task.dependsOn !== undefined ? `
                      <span style="background: #ff9f43; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                        ‚¨ÖÔ∏è Po #${task.dependsOn + 1}
                      </span>
                    ` : ''}
                    <button onclick="editTaskTime(${idx})" style="background: #667eea; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">
                      ‚úèÔ∏è Upravi≈•
                    </button>
                  </div>
                </div>
                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                  üë§ ${task.calendarName} ‚Ä¢ ‚è±Ô∏è ${task.duration}h
                </div>
                ${start && end ? `
                  <div style="font-size: 13px; color: #4caf50; font-weight: 600; cursor: pointer;" onclick="showMiniCalendar(${idx}, '${start.toISOString()}', '${end.toISOString()}')">
                    üïê ${start.toLocaleString('sk-SK', {dateStyle: 'short', timeStyle: 'short'})} ‚Üí ${end.toLocaleTimeString('sk-SK', {timeStyle: 'short'})}
                    <span style="font-size: 11px; color: #667eea; margin-left: 8px;">üìÖ klikni pre kalend√°r</span>
                  </div>
                  <div id="mini-calendar-${idx}" style="display: none; margin-top: 10px;"></div>
                ` : `
                  <div style="font-size: 13px; color: #ff4757; font-weight: 600;">
                    ‚ö†Ô∏è ${task.error || 'Nena≈°iel sa voƒæn√Ω ƒças'}
                  </div>
                `}
                ${task.reasoning ? `
                  <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #555;">
                    üí° ${task.reasoning}
                  </div>
                ` : ''}
              </div>
            `;
          });
          
          // Ulo≈æ pl√°n do glob√°lnej premennej pre drag & drop
          window.currentOptimizedPlan = result.plan;
          
          planHTML += `
              </div>
              
              <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0; color: #667eea;">üìä Interakt√≠vny Timeline</h4>
                <button onclick="showTimelineView()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                  üóìÔ∏è Zobrazi≈• ƒçasov√∫ os (Drag & Drop)
                </button>
              </div>
              
              <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                  ü§ñ AI automaticky zistila z√°vislosti medzi procesmi a navrhla optim√°lny rozvrh.
                </p>
                <div style="display: flex; gap: 10px;">
                  <button onclick="applyOptimizedPlan(${JSON.stringify(result.plan).replace(/"/g, '&quot;')})" style="flex: 1; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    ‚úÖ Pou≈æi≈• tento pl√°n
                  </button>
                  <button onclick="const lastMsg = messagesDiv.lastElementChild; if(lastMsg) lastMsg.remove();" style="padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    ‚ùå Zavrie≈•
                  </button>
                </div>
              </div>
            </div>
          `;
          
          addMessage('assistant', planHTML);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } else {
          addMessage('assistant', `‚ùå Chyba AI optimaliz√°cie: ${result.error}`);
        }
      } catch (error) {
        // Odstr√°≈à loading
        const lastMessage = messagesDiv.lastElementChild;
        if (lastMessage) lastMessage.remove();
        
        addMessage('assistant', `‚ùå Chyba: ${error.message}`);
      }
    }

    // Aplikuj optimalizovan√Ω pl√°n
    function applyOptimizedPlan(plan) {
      // Ulo≈æ optimalizovan√Ω pl√°n do glob√°lnej premennej
      window.optimizedPlan = plan;
      
      // Odstr√°≈à spr√°vu s pl√°nom
      const lastMessage = messagesDiv.lastElementChild;
      if (lastMessage) lastMessage.remove();
      
      // Zavolaj submitOrderAdvanced s optimalizovan√Ωmi ƒçasmi
      submitOrderAdvancedWithPlan(plan);
    }

    async function submitOrderAdvanced() {
      const orderName = document.getElementById('orderName').value.trim();
      const orderDeadline = document.getElementById('orderDeadline').value;
      
      if (!orderName) {
        alert('Zadajte n√°zov z√°kazky!');
        return;
      }
      
      if (!orderDeadline) {
        alert('Zadajte term√≠n dokonƒçenia!');
        return;
      }
      
      // Z√≠skaj v≈°etky procesy
      const taskRows = document.querySelectorAll('.task-row');
      if (taskRows.length === 0) {
        alert('Pridajte aspo≈à jeden proces!');
        return;
      }
      
      const tasks = [];
      for (const row of taskRows) {
        const calendarId = row.querySelector('.task-calendar').value;
        const durationStr = row.querySelector('.task-duration').value.replace(',', '.'); // Slovensk√° ƒçiarka ‚Üí bodka
        const duration = parseFloat(durationStr);
        const description = row.querySelector('.task-description').value.trim();
        
        if (!calendarId) {
          alert('Vyberte kalend√°r pre v≈°etky procesy!');
          return;
        }
        
        if (isNaN(duration) || duration <= 0) {
          alert('Zadajte platn√© trvanie (napr. 1.5 alebo 1,5 hodiny)!');
          return;
        }
        
        if (!description) {
          alert('Zadajte popis pre v≈°etky procesy!');
          return;
        }
        
        // N√°jdi n√°zov kalend√°ra
        const calendar = window.availableCalendars.find(c => c.id === calendarId);
        
        tasks.push({
          calendarId: calendarId,
          calendarName: calendar ? calendar.name : 'Nezn√°my',
          duration: duration,
          description: description
        });
      }
      
      // Zobraz loading
      closeOrderForm();
      addMessage('assistant', `‚è≥ Vytv√°ram z√°kazku "${orderName}" s ${tasks.length} procesmi...`);
      
      // Vytvor JSON pre server
      const orderData = {
        name: orderName,
        deadline: orderDeadline,
        tasks: tasks
      };
      
      try {
        // Po≈°li na server
        const response = await fetch('/api/create-order-advanced', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          addMessage('assistant', `‚úÖ ${result.message}`);
          loadEvents(); // Refresh calendar
        } else {
          addMessage('assistant', `‚ùå Chyba: ${result.error}`);
        }
      } catch (error) {
        addMessage('assistant', `‚ùå Chyba: ${error.message}`);
      }
    }

    // Vytvor z√°kazku s AI optimalizovan√Ωmi ƒçasmi
    async function submitOrderAdvancedWithPlan(optimizedPlan) {
      const orderName = document.getElementById('orderName').value.trim();
      
      if (!orderName) {
        alert('Zadajte n√°zov z√°kazky!');
        return;
      }
      
      // Zobraz loading
      closeOrderForm();
      addMessage('assistant', `‚è≥ Vytv√°ram optimalizovan√∫ z√°kazku "${orderName}"...`);
      
      try {
        const createdEvents = [];
        const errors = [];
        
        // Vytvor udalosti s AI ƒçasmi
        for (const task of optimizedPlan) {
          if (!task.suggestedStart || !task.suggestedEnd) {
            errors.push(`Preskoƒçen√©: ${task.description} (≈æiadny voƒæn√Ω slot)`);
            continue;
          }
          
          try {
            // Priprav d√°ta pre Google Apps Script
            const eventData = {
              calendarId: task.calendarId,
              summary: `${orderName} - ${task.description}`,
              description: `üì¶ Z√°kazka: ${orderName}\nüìù Proces: ${task.description}\n‚è±Ô∏è Trvanie: ${task.duration}h\nüë§ Pridelen√©: ${task.calendarName}\n\nü§ñ AI optimalizovan√©`,
              start: { dateTime: task.suggestedStart },
              end: { dateTime: task.suggestedEnd },
              location: 'V√Ωroba'
            };
            
            // Volaj cez server (ob√≠de CORS)
            const eventResponse = await fetch('/api/create-event', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(eventData)
            });
            
            const eventResult = await eventResponse.json();
            
            if (eventResult.ok) {
              createdEvents.push({
                calendar: task.calendarName,
                process: task.description,
                start: task.suggestedStart,
                end: task.suggestedEnd,
                duration: task.duration
              });
            } else {
              errors.push(`Chyba pri vytv√°ran√≠ "${task.description}": ${eventResult.error || 'Nezn√°ma chyba'}`);
            }
          } catch (error) {
            errors.push(`Chyba pri vytv√°ran√≠ "${task.description}": ${error.message}`);
          }
        }
        
        // Zostav spr√°vu
        let message = `ü§ñ AI optimalizovan√° z√°kazka "${orderName}" bola vytvoren√°!\\n\\n`;
        message += `‚úÖ Vytvoren√©: ${createdEvents.length}/${optimizedPlan.length} procesov\\n\\n`;
        
        if (createdEvents.length > 0) {
          message += `üìä Procesy:\\n\\n`;
          createdEvents.forEach((ev, idx) => {
            const start = new Date(ev.start);
            const end = new Date(ev.end);
            message += `${idx + 1}. ${ev.process}\\n`;
            message += `   üë§ ${ev.calendar}\\n`;
            message += `   üïê ${start.toLocaleString('sk-SK', { dateStyle: 'short', timeStyle: 'short' })} ‚Üí ${end.toLocaleTimeString('sk-SK', { timeStyle: 'short' })}\\n`;
            message += `   ‚è±Ô∏è ${ev.duration}h\\n\\n`;
          });
        }
        
        if (errors.length > 0) {
          message += `\\n‚ö†Ô∏è Chyby (${errors.length}):\\n${errors.join('\\n')}`;
        }
        
        addMessage('assistant', message);
        loadEvents(); // Refresh calendar
        
      } catch (error) {
        addMessage('assistant', `‚ùå Chyba: ${error.message}`);
      }
    }

    // ===== DRAG & DROP A MINI KALEND√ÅR =====
    
    let draggedTaskIndex = null;
    
    // Drag & Drop handling
    document.addEventListener('dragstart', (e) => {
      if (e.target.classList.contains('task-plan-item')) {
        draggedTaskIndex = parseInt(e.target.id.replace('task-plan-', ''));
        e.target.style.opacity = '0.5';
      }
    });
    
    document.addEventListener('dragend', (e) => {
      if (e.target.classList.contains('task-plan-item')) {
        e.target.style.opacity = '1';
      }
    });
    
    document.addEventListener('dragover', (e) => {
      e.preventDefault();
      if (e.target.classList.contains('task-plan-item')) {
        e.target.style.borderTop = '3px solid #667eea';
      }
    });
    
    document.addEventListener('dragleave', (e) => {
      if (e.target.classList.contains('task-plan-item')) {
        e.target.style.borderTop = '';
      }
    });
    
    document.addEventListener('drop', (e) => {
      e.preventDefault();
      if (e.target.classList.contains('task-plan-item')) {
        e.target.style.borderTop = '';
        const dropIndex = parseInt(e.target.id.replace('task-plan-', ''));
        
        if (draggedTaskIndex !== null && draggedTaskIndex !== dropIndex) {
          // Preusporiadaj pl√°n
          reorderTasks(draggedTaskIndex, dropIndex);
        }
        
        draggedTaskIndex = null;
      }
    });
    
    function reorderTasks(fromIndex, toIndex) {
      if (!window.currentOptimizedPlan) return;
      
      // Presun √∫lohu
      const plan = [...window.currentOptimizedPlan];
      const [movedTask] = plan.splice(fromIndex, 1);
      plan.splice(toIndex, 0, movedTask);
      
      window.currentOptimizedPlan = plan;
      
      // Refresh zobrazenia (znovuvytvorenie pl√°nov√©ho HTML)
      console.log('Preusporiadan√©:', plan.map(t => t.description));
      alert(`√öloha "${movedTask.description}" presunut√° z poz√≠cie ${fromIndex + 1} na ${toIndex + 1}.\n\nPozor: ƒåasy sa automaticky neprepoƒç√≠taj√∫. Pou≈æite tlaƒçidlo "üîÑ Prepoƒç√≠ta≈• ƒçasy" alebo upravte ruƒçne.`);
    }
    
    // Mini kalend√°r
    function showMiniCalendar(taskIndex, startISO, endISO) {
      const container = document.getElementById(`mini-calendar-${taskIndex}`);
      if (!container) return;
      
      // Toggle zobrazenie
      if (container.style.display === 'block') {
        container.style.display = 'none';
        return;
      }
      
      const start = new Date(startISO);
      const month = start.getMonth();
      const year = start.getFullYear();
      
      // Vytvor mini kalend√°r
      let calHTML = `
        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; border: 2px solid #667eea;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong style="color: #667eea;">${start.toLocaleDateString('sk-SK', { month: 'long', year: 'numeric' })}</strong>
            <button onclick="document.getElementById('mini-calendar-${taskIndex}').style.display='none'" style="background: #f0f0f0; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 12px;">
            <div style="text-align: center; font-weight: 600; color: #666;">Po</div>
            <div style="text-align: center; font-weight: 600; color: #666;">Ut</div>
            <div style="text-align: center; font-weight: 600; color: #666;">St</div>
            <div style="text-align: center; font-weight: 600; color: #666;">≈†t</div>
            <div style="text-align: center; font-weight: 600; color: #666;">Pi</div>
            <div style="text-align: center; font-weight: 600; color: #666;">So</div>
            <div style="text-align: center; font-weight: 600; color: #666;">Ne</div>
      `;
      
      // Zisti prv√Ω de≈à mesiaca
      const firstDay = new Date(year, month, 1);
      let firstDayOfWeek = firstDay.getDay();
      if (firstDayOfWeek === 0) firstDayOfWeek = 7; // Nedeƒæa = 7
      firstDayOfWeek -= 1; // Pondelok = 0
      
      // Pr√°zdne bunky pred prv√Ωm d≈àom
      for (let i = 0; i < firstDayOfWeek; i++) {
        calHTML += `<div></div>`;
      }
      
      // Dni v mesiaci
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const selectedDate = start.getDate();
      
      for (let day = 1; day <= daysInMonth; day++) {
        const isSelected = day === selectedDate;
        const dayDate = new Date(year, month, day);
        const isWeekend = dayDate.getDay() === 0 || dayDate.getDay() === 6;
        
        calHTML += `
          <div onclick="selectNewDate(${taskIndex}, ${year}, ${month}, ${day})" 
               style="text-align: center; padding: 6px; border-radius: 4px; cursor: pointer; 
                      background: ${isSelected ? '#667eea' : (isWeekend ? '#ffe0e0' : 'white')}; 
                      color: ${isSelected ? 'white' : (isWeekend ? '#d63031' : '#333')}; 
                      font-weight: ${isSelected ? '600' : 'normal'};">
            ${day}
          </div>
        `;
      }
      
      calHTML += `
          </div>
          
          <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px;">ƒåas zaƒçiatku:</label>
            <input type="time" id="task-${taskIndex}-time" value="${start.toTimeString().substring(0, 5)}" 
                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
            
            <button onclick="applyNewTime(${taskIndex})" 
                    style="width: 100%; margin-top: 8px; padding: 8px; background: #4caf50; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">
              ‚úÖ Pou≈æi≈• nov√Ω ƒças
            </button>
          </div>
        </div>
      `;
      
      container.innerHTML = calHTML;
      container.style.display = 'block';
    }
    
    function selectNewDate(taskIndex, year, month, day) {
      const task = window.currentOptimizedPlan[taskIndex];
      const currentStart = new Date(task.suggestedStart);
      
      // Zachovaj p√¥vodn√Ω ƒças, zme≈à iba d√°tum
      const newStart = new Date(year, month, day, currentStart.getHours(), currentStart.getMinutes());
      
      // Aktualizuj zobrazenie ƒçasu
      const timeInput = document.getElementById(`task-${taskIndex}-time`);
      if (timeInput) {
        timeInput.value = newStart.toTimeString().substring(0, 5);
      }
      
      // Zobraz vybran√Ω d√°tum
      console.log(`Nov√Ω d√°tum: ${newStart.toLocaleDateString('sk-SK')}`);
    }
    
    function applyNewTime(taskIndex) {
      const task = window.currentOptimizedPlan[taskIndex];
      const timeInput = document.getElementById(`task-${taskIndex}-time`);
      
      if (!timeInput) return;
      
      const [hours, minutes] = timeInput.value.split(':');
      const currentStart = new Date(task.suggestedStart);
      
      // Vytvor nov√Ω ƒças
      const newStart = new Date(currentStart);
      newStart.setHours(parseInt(hours), parseInt(minutes), 0);
      
      const newEnd = new Date(newStart.getTime() + task.duration * 60 * 60 * 1000);
      
      // Aktualizuj pl√°n
      window.currentOptimizedPlan[taskIndex].suggestedStart = newStart.toISOString();
      window.currentOptimizedPlan[taskIndex].suggestedEnd = newEnd.toISOString();
      
      // Ozn√°m zmenu
      addMessage('assistant', `‚úÖ ƒåas procesu "${task.description}" zmenen√Ω na: ${newStart.toLocaleString('sk-SK', {dateStyle: 'short', timeStyle: 'short'})}`);
      
      // Zavri mini kalend√°r
      const container = document.getElementById(`mini-calendar-${taskIndex}`);
      if (container) container.style.display = 'none';
      
      // Refresh zobrazenia
      alert('ƒåas bol zmenen√Ω! Ak chcete vytvori≈• z√°kazku s nov√Ωm ƒçasom, kliknite "‚úÖ Pou≈æi≈• tento pl√°n".');
    }
    
    // Edit√°cia ƒçasu inline
    function editTaskTime(taskIndex) {
      const task = window.currentOptimizedPlan[taskIndex];
      const start = new Date(task.suggestedStart);
      
      const newTimeStr = prompt(
        `Upravte ƒças zaƒçiatku pre: ${task.description}\n\nAktu√°lny ƒças: ${start.toLocaleString('sk-SK', {dateStyle: 'short', timeStyle: 'short'})}\n\nZadajte nov√Ω ƒças (form√°t: DD.MM.YYYY HH:MM):`, 
        start.toLocaleString('sk-SK', {dateStyle: 'short', timeStyle: 'short'})
      );
      
      if (!newTimeStr) return;
      
      try {
        // Parse form√°tu "19.10.2025, 14:30"
        const parts = newTimeStr.split(',');
        const dateParts = parts[0].trim().split('.');
        const timeParts = parts[1].trim().split(':');
        
        const newStart = new Date(
          parseInt(dateParts[2]), // rok
          parseInt(dateParts[1]) - 1, // mesiac (0-indexed)
          parseInt(dateParts[0]), // de≈à
          parseInt(timeParts[0]), // hodiny
          parseInt(timeParts[1]) // min√∫ty
        );
        
        if (isNaN(newStart.getTime())) {
          throw new Error('Neplatn√Ω form√°t');
        }
        
        const newEnd = new Date(newStart.getTime() + task.duration * 60 * 60 * 1000);
        
        // Aktualizuj pl√°n
        window.currentOptimizedPlan[taskIndex].suggestedStart = newStart.toISOString();
        window.currentOptimizedPlan[taskIndex].suggestedEnd = newEnd.toISOString();
        
        addMessage('assistant', `‚úÖ ƒåas procesu "${task.description}" zmenen√Ω na: ${newStart.toLocaleString('sk-SK', {dateStyle: 'short', timeStyle: 'short'})}`);
        
        alert('ƒåas bol zmenen√Ω! Ak chcete vytvori≈• z√°kazku s nov√Ωm ƒçasom, kliknite "‚úÖ Pou≈æi≈• tento pl√°n".');
      } catch (error) {
        alert('Neplatn√Ω form√°t ƒçasu! Pou≈æite form√°t: DD.MM.YYYY, HH:MM');
      }
    }

    // ===== INTERAKT√çVNY TIMELINE VIEW =====
    function showTimelineView() {
      if (!window.currentOptimizedPlan || window.currentOptimizedPlan.length === 0) {
        alert('≈Ωiadny pl√°n na zobrazenie!');
        return;
      }
      
      // N√°jdi ƒçasov√Ω rozsah
      const allDates = window.currentOptimizedPlan
        .filter(t => t.suggestedStart)
        .map(t => new Date(t.suggestedStart));
      
      if (allDates.length === 0) {
        alert('≈Ωiadne ƒçasov√© √∫daje!');
        return;
      }
      
      const minDate = new Date(Math.min(...allDates));
      const maxDate = new Date(Math.max(...window.currentOptimizedPlan.filter(t => t.suggestedEnd).map(t => new Date(t.suggestedEnd))));
      
      // Vytvor timeline HTML
      let timelineHTML = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #667eea;">üìä Interakt√≠vny Timeline - ≈§ahaj √∫lohy</h3>
            <button onclick="const lastMsg = messagesDiv.lastElementChild; if(lastMsg) lastMsg.remove();" 
                    style="background: #f0f0f0; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-weight: 600;">
              ‚úï Zavrie≈•
            </button>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="font-size: 14px; color: #666;">
                üìÖ ${minDate.toLocaleDateString('sk-SK', {dateStyle: 'medium'})} - ${maxDate.toLocaleDateString('sk-SK', {dateStyle: 'medium'})}
              </span>
              <span style="font-size: 14px; color: #666;">
                üïê Pracovn√© hodiny: 8:00 - 17:00
              </span>
            </div>
          </div>
          
          <div id="timeline-container" style="background: white; border-radius: 8px; padding: 20px; padding-left: 170px; overflow-x: auto; position: relative;">
            ${generateTimelineGrid(minDate, maxDate)}
          </div>
          
          <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
            <strong style="color: #856404;">üí° N√°vod:</strong>
            <ul style="margin: 8px 0 0 20px; font-size: 13px; color: #856404;">
              <li>Kliknite a ≈•ahajte √∫lohu horizont√°lne = zmena ƒçasu zaƒçiatku</li>
              <li>Kliknite a ≈•ahajte prav√Ω okraj = zmena dƒ∫≈æky</li>
              <li>Dvojklik = r√Ωchla edit√°cia</li>
            </ul>
          </div>
          
          <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button onclick="applyOptimizedPlan(window.currentOptimizedPlan)" 
                    style="flex: 1; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
              ‚úÖ Pou≈æi≈• upraven√Ω pl√°n
            </button>
            <button onclick="const lastMsg = messagesDiv.lastElementChild; if(lastMsg) lastMsg.remove();" 
                    style="padding: 12px 20px; background: #f0f0f0; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
              ‚ùå Zavrie≈•
            </button>
          </div>
        </div>
      `;
      
      addMessage('assistant', timelineHTML);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      // Inicializuj drag & drop pre timeline
      initializeTimelineDragDrop();
    }
    
    function generateTimelineGrid(minDate, maxDate) {
      let html = '<div style="position: relative; min-height: 400px;">';
      
      // Vypoƒç√≠taj poƒçet dn√≠
      const daysDiff = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
      const daysToShow = Math.max(1, daysDiff);
      
      // Pracovn√© hodiny
      const workingHours = { start: 8, end: 17 };
      const hoursPerDay = workingHours.end - workingHours.start;
      const pixelsPerHour = 80;
      const pixelsPerDay = hoursPerDay * pixelsPerHour;
      const totalWidth = daysToShow * pixelsPerDay;
      
      // === HLAVIƒåKA S D≈áAMI A HODINAMI ===
      html += '<div style="border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 10px;">';
      
      // Riadok s d√°tumami
      html += '<div style="display: flex; margin-bottom: 5px;">';
      for (let d = 0; d < daysToShow; d++) {
        const currentDay = new Date(minDate);
        currentDay.setDate(currentDay.getDate() + d);
        const dayName = currentDay.toLocaleDateString('sk-SK', { weekday: 'short', day: 'numeric', month: 'short' });
        const isWeekend = currentDay.getDay() === 0 || currentDay.getDay() === 6;
        
        html += `
          <div style="width: ${pixelsPerDay}px; text-align: center; font-size: 13px; font-weight: 600; 
                      color: ${isWeekend ? '#d63031' : '#667eea'}; background: ${isWeekend ? '#ffe0e0' : '#f0f3ff'}; 
                      padding: 8px 0; border-radius: 6px; margin-right: 2px;">
            ${dayName}
          </div>
        `;
      }
      html += '</div>';
      
      // Riadok s hodinami
      html += '<div style="display: flex;">';
      for (let d = 0; d < daysToShow; d++) {
        html += '<div style="display: flex; margin-right: 2px;">';
        for (let h = workingHours.start; h < workingHours.end; h++) {
          html += `<div style="width: ${pixelsPerHour}px; text-align: center; font-size: 10px; color: #999;">${h}:00</div>`;
        }
        html += '</div>';
      }
      html += '</div>';
      
      html += '</div>';
      
      // === RIADKY PRE KA≈ΩD√ù KALEND√ÅR ===
      const calendarGroups = {};
      window.currentOptimizedPlan.forEach((task, idx) => {
        if (!calendarGroups[task.calendarId]) {
          calendarGroups[task.calendarId] = {
            name: task.calendarName,
            tasks: []
          };
        }
        calendarGroups[task.calendarId].tasks.push({ ...task, index: idx });
      });
      
      let rowIndex = 0;
      for (const [calendarId, group] of Object.entries(calendarGroups)) {
        const rowTop = 40 + rowIndex * 80;
        
        // N√°zov kalend√°ra
        html += `
          <div style="position: absolute; left: -150px; top: ${rowTop}px; width: 140px; font-size: 12px; font-weight: 600; color: #667eea;">
            ${group.name}
          </div>
        `;
        
        // Background riadku s deƒæen√≠m na dni
        for (let d = 0; d < daysToShow; d++) {
          const currentDay = new Date(minDate);
          currentDay.setDate(currentDay.getDate() + d);
          const isWeekend = currentDay.getDay() === 0 || currentDay.getDay() === 6;
          const dayLeft = d * pixelsPerDay;
          
          html += `
            <div style="position: absolute; 
                        left: ${dayLeft}px; 
                        top: ${rowTop}px; 
                        width: ${pixelsPerDay}px; 
                        height: 60px; 
                        background: ${isWeekend ? '#fff5f5' : '#f8f9fa'}; 
                        border-radius: 4px;
                        border-right: 2px solid #e0e0e0;"></div>
          `;
        }
        
        // √ölohy v tomto kalend√°ri
        group.tasks.forEach(task => {
          if (!task.suggestedStart) return;
          
          const start = new Date(task.suggestedStart);
          const end = new Date(task.suggestedEnd);
          
          // Ktor√Ω de≈à?
          const taskDay = Math.floor((start - minDate) / (1000 * 60 * 60 * 24));
          if (taskDay < 0 || taskDay >= daysToShow) return; // Mimo rozsahu
          
          // Poz√≠cia v r√°mci d≈àa
          const startHour = start.getHours() + start.getMinutes() / 60;
          const endHour = end.getHours() + end.getMinutes() / 60;
          
          const dayOffset = taskDay * pixelsPerDay;
          const left = dayOffset + (startHour - workingHours.start) * pixelsPerHour;
          const width = (endHour - startHour) * pixelsPerHour;
          
          const color = task.canRunParallel ? '#00d2ff' : '#667eea';
          
          html += `
            <div id="timeline-task-${task.index}" 
                 class="timeline-task-bar"
                 data-task-index="${task.index}"
                 data-task-day="${taskDay}"
                 draggable="true"
                 ondblclick="editTaskTime(${task.index})"
                 style="position: absolute; 
                        left: ${left}px; 
                        top: ${rowTop + 5}px; 
                        width: ${width}px; 
                        height: 50px; 
                        background: ${color}; 
                        color: white; 
                        border-radius: 6px; 
                        padding: 8px; 
                        cursor: move;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                        font-size: 11px;
                        overflow: hidden;
                        user-select: none;">
              <div style="font-weight: 600; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${task.description}</div>
              <div style="font-size: 10px; opacity: 0.9;">
                ${start.toLocaleTimeString('sk-SK', {timeStyle: 'short'})} - ${end.toLocaleTimeString('sk-SK', {timeStyle: 'short'})} (${task.duration}h)
              </div>
            </div>
          `;
        });
        
        rowIndex++;
      }
      
      html += '</div>';
      return html;
    }
    
    let draggedTimelineTask = null;
    let dragStartX = 0;
    let dragStartLeft = 0;
    let isResizing = false;
    let resizeStartWidth = 0;
    
    function initializeTimelineDragDrop() {
      // Drag start
      document.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('timeline-task-bar')) {
          draggedTimelineTask = e.target;
          dragStartX = e.clientX;
          dragStartLeft = parseInt(draggedTimelineTask.style.left);
          e.target.style.opacity = '0.5';
        }
      });
      
      document.addEventListener('dragend', (e) => {
        if (draggedTimelineTask) {
          draggedTimelineTask.style.opacity = '1';
          draggedTimelineTask = null;
        }
      });
      
      document.addEventListener('dragover', (e) => {
        e.preventDefault();
      });
      
      document.addEventListener('drag', (e) => {
        if (draggedTimelineTask && e.clientX > 0) {
          const deltaX = e.clientX - dragStartX;
          const newLeft = Math.max(0, dragStartLeft + deltaX);
          
          // Konvertuj pixely na hodiny
          const pixelsPerHour = 80;
          const hoursFromStart = newLeft / pixelsPerHour;
          const newStartHour = 8 + hoursFromStart;
          
          // Aktualizuj ƒças v pl√°ne
          const taskIndex = parseInt(draggedTimelineTask.dataset.taskIndex);
          const task = window.currentOptimizedPlan[taskIndex];
          const originalStart = new Date(task.suggestedStart);
          
          const newStart = new Date(originalStart);
          newStart.setHours(Math.floor(newStartHour), (newStartHour % 1) * 60);
          
          const newEnd = new Date(newStart.getTime() + task.duration * 60 * 60 * 1000);
          
          task.suggestedStart = newStart.toISOString();
          task.suggestedEnd = newEnd.toISOString();
          
          // Vizu√°lny update
          draggedTimelineTask.style.left = newLeft + 'px';
        }
      });
    }


    async function submitOrder() {
      const orderName = document.getElementById('orderName').value.trim();
      const orderDeadline = document.getElementById('orderDeadline').value;
      
      if (!orderName) {
        alert('Zadajte n√°zov z√°kazky!');
        return;
      }
      
      if (!orderDeadline) {
        alert('Zadajte term√≠n dokonƒçenia!');
        return;
      }
      
      // Z√≠skaj vybran√© √∫lohy
      const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      if (checkboxes.length === 0) {
        alert('Vyberte aspo≈à jednu √∫lohu!');
        return;
      }
      
      const tasks = Array.from(checkboxes).map(cb => ({
        position: cb.dataset.position,
        duration: parseInt(cb.dataset.duration),
        label: cb.nextElementSibling.textContent
      }));
      
      // Zobraz loading
      closeOrderForm();
      addMessage('assistant', '‚è≥ Vytv√°ram √∫lohy a priraƒèujem zamestnancom...');
      
      // Vytvor JSON pre server
      const orderData = {
        name: orderName,
        deadline: orderDeadline,
        tasks: tasks
      };
      
      try {
        // Po≈°li na server
        const response = await fetch('/api/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          addMessage('assistant', `‚úÖ Z√°kazka "${orderName}" bola vytvoren√°!\\n\\n${result.message}`);
          loadEvents(); // Refresh calendar
        } else {
          addMessage('assistant', `‚ùå Chyba: ${result.error}`);
        }
      } catch (error) {
        addMessage('assistant', `‚ùå Chyba: ${error.message}`);
      }
    }

    // Auto-refresh kalend√°ra ka≈æd√Ωch 60 sek√∫nd (bez loading indicator)
    setInterval(() => loadEvents(false), 60000);
  </script>
</body>
</html>

